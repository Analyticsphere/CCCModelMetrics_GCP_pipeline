---
title: "CCC Weekly Module Metrics"
author: "Kelsey Sanchez"
date: 'Data Extracted and Report Ran: `r Sys.Date()`'
header-includes: 
  \usepackage[labelformat=empty]{caption} 
  \usepackage{placeins} 
  \usepackage{booktabs}
  \usepackage{pdflscape}
  
output:
  pdf_document:
    latex_engine: xelatex
    extra_dependencies: ["float"]
    toc: no
    keep_tex: yes
    fig_width: 7
    fig_height: 5
    fig_caption: yes
    df_print: paged
---






```{r libraries, include=FALSE, warning=FALSE}

 # \usepackage{caption}
 # \captionsetup[figure]{labelformat=empty}


#old.packages()
#update.packages("tinytex")


library(bigrquery)
library(dplyr)
library(gmodels)
library(epiDisplay)
library(lubridate)
library(tidyverse)
library(knitr)
#install_tinytex()
library(tinytex)
#library(vtable)
library(kableExtra)
library(gtsummary)
library(data.table)


library(arsenal)
library(rio)
library(scales)
library(gt)
library(stringr) 


bq_auth()


# ```{r setup, include=FALSE}
# options(width = 80)
# options(tinytex.verbose = TRUE) --- didn't work
# ```

```


In order of how the sections appear on MyConnect, the Initial Survey Sections are:  

BOH= Background and Overall Health (Module 1)  

LAW= Where you Live and Work (Module 4)

MRE= Medications, Reproductive Health, Exercise, and Sleep (Module 2)

SAS= Smoking, Alcohol, and Sun Exposure (Module 3)





```{r BQPull, include=FALSE}
knitr::opts_chunk$set(dev = "png", fig.path = "", comment = NA)

#knitr::opts_chunk$set(comment = NA)

project = "nih-nci-dceg-connect-prod-6d04"
queryreccc <- "SELECT  Connect_ID, d_512820379, d_821247024, d_914594314, d_832139544, d_949302066 , d_205553981, 
d_536735468 , d_976570371, d_663265240, d_265193023, d_222161762,d_770257102, d_264644252, d_265193023, d_541836531, 
d_386488297, d_452942800, d_517311251 , d_822499427, d_126331570, d_914639140, d_311580100, d_827220437, d_100767870, 
d_831041022, d_255077064, d_320303124, d_684635302, d_843688458, d_870643066, d_878865966, d_167958071, token,
state_d_934298480, state_d_706256705, state_d_435027713
FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP` where Connect_ID IS NOT NULL  and (d_512820379='486306141' OR d_512820379='854703046') " 

#and d_831041022='104430631'-- not needed, according to 3/12/24 decisions we'll be keeping participant journeys in overall counts

rec_table_cc <- bq_project_query(project, queryreccc)
data_c <- bq_table_download(rec_table_cc, bigint = "integer64")


#need this separate filter to look at participants unable to be verified
data_ccc <- data_c %>%  filter(d_821247024==197316935) 


data_tib= as_tibble(data_ccc) 


modules <- data_tib[,c("Connect_ID","d_512820379","d_949302066","d_536735468","d_976570371","d_663265240", "d_914594314")] 
mods <- c("d_949302066","d_536735468","d_976570371","d_663265240")
modules$modules <- 0
modules$none <-0
for(i in 1:length(mods)){
  module <- modules[,mods[i]]
  count <- ifelse((!is.na(module) & module ==231311385), 1, 0)
  modules$modules <- count+modules$modules
  count1 <- ifelse((!is.na(module) & module==972455046), 1, 0)
  modules$none <- count1+modules$none
}



length(modules[which(modules$modules==3 & modules$d_663265240==231311385 & modules$d_536735468==231311385),])

modules1 <- modules %>% mutate(process = case_when(as.character(modules) =='0' ~ "None",
                                                   d_949302066 == '231311385' & as.character(modules) == '1' ~ "BOH Section only",
                                                   as.character(modules) == '2' & d_949302066 == '231311385' & d_536735468 == '231311385' ~ "BOH and MRE Sections" ,
                                                   as.character(modules) =='2' & d_949302066 == '231311385' & d_976570371 == '231311385' ~ "BOH and SAS Sections" , 
                                                   as.character(modules) =='2' & d_949302066 == '231311385' & d_663265240 == '231311385' ~ "BOH and LAW Sections" ,  
                                                   as.character(modules) =='3' & d_949302066 == '231311385' & d_536735468 == '231311385' & d_976570371 == '231311385' ~ "BOH, MRE, and SAS Sections" ,  
                                                   as.character(modules) =='3' & d_949302066 == '231311385' & d_976570371 == '231311385' & d_663265240 == '231311385'~ "BOH, SAS, and LAW Sections" , 
                                                   as.character(modules) =='3' & d_949302066 == '231311385' & d_536735468 == '231311385' & d_663265240 == '231311385' ~ "BOH, MRE, and LAW Sections",   
                                                   as.character(modules) =='4' ~ "All")) 

tab1(modules1$process, decimal=2,sort.group = "decreasing", cum.percent = TRUE)$output.table


#completion <- modules1 %>% select(Connect_ID, process) #have no idea why this isn't working
completion <- modules1[, c(1,10)]
all_data <- left_join(data_tib, completion, by="Connect_ID")


all_data <- all_data %>%  mutate(Site = case_when(d_827220437==472940358 ~ "Baylor Scott and White Health",
                                                  d_827220437==125001209 ~ "KP Colorado",
                                                  d_827220437==327912200 ~ "KP Georgia",
                                                  d_827220437==300267574 ~ "KP Hawaii",
                                                  d_827220437==452412599 ~ "KP Northwest",
                                                  d_827220437==548392715 ~ "Henry Ford",
                                                  d_827220437==531629870 ~ "HealthPartners",
                                                  d_827220437==303349821 ~ "Marshfield",
                                                  d_827220437==657167265 ~ "Sanford",
                                                  d_827220437==809703864 ~ "UChicago"),
                                 age = case_when(state_d_934298480 == "713781738"~ "30-34",
                                                 state_d_934298480 == '631272782' ~ "35-39",
                                                 state_d_934298480 == '124276120' ~ "40-45",
                                                 state_d_934298480 == '450985724' ~ "46-50",
                                                 state_d_934298480 == '363147933' ~ "51-55",
                                                 state_d_934298480 == '636706443' ~ "56-60",
                                                 state_d_934298480 == '771230670' ~ "61-65",
                                                 state_d_934298480 == '722846087' ~ "66-70"),
                                 sex = case_when(state_d_706256705 == '536341288' | state_d_435027713 == '536341288' ~ "Female",
                                                 state_d_706256705 == '654207589' | state_d_435027713 == '654207589' ~ "Male",
                                                 #state_d_706256705 == '830573274' ~ "Intersex or Other", # too small of a count for now, need to combine with unknown 
                                                 state_d_706256705 == '830573274' | state_d_706256705 == '178420302' | state_d_435027713 == '178420302' ~ "Unknown"),
                                 BSL_compl = case_when(d_100767870==353358909 ~ "All Baseline Modules Completed",
                                                       TRUE ~ "One or More Baseline Modules Not Completed"),
                                 Pref_lang=case_when(d_255077064 == 773342525 ~ "Spanish",
                                                     TRUE ~ "English"),
                                 Recruit_Type= case_when(d_512820379==486306141 ~ "Active",
                                                  d_512820379==854703046 ~ "Passive"),
                                 qolcomplt = ifelse(d_320303124 == 231311385 ,"Submitted",
                                                    ifelse(d_320303124 == 615768760, "Started",
                                                           ifelse(as.numeric(difftime(Sys.Date(), as.POSIXct(ymd_hms(d_914594314)),
                                                                                      units="days")) < 90, "Not Eligible",
                                                                  ifelse(d_320303124 == 972455046, "Not Started", "Error")))),
                                 completion = case_when(d_100767870=="353358909" & 
                                                          (d_878865966=="353358909" | d_684635302=="353358909" | d_167958071=="353358909") ~ "Completed both survey and sample(s)",
                                                        d_100767870=="353358909" ~ "Completed all baseline survey modules 1-4, no baseline samples",
                                                        (d_878865966=="353358909" | d_684635302=="353358909" | 
                                                           d_167958071=="353358909") ~ "Completed any baseline sample, did not complete baseline survey",
                                                        TRUE ~ "Completed neither survey or sample(s)"),
                                 m1_comp_mins = as.numeric(difftime(as.POSIXct(ymd_hms(d_517311251)), as.POSIXct(ymd_hms(d_205553981)), units="hours"))*60,
                                 m2_comp_mins = as.numeric(difftime(as.POSIXct(ymd_hms(d_832139544)), as.POSIXct(ymd_hms(d_541836531)), units="hours"))*60,
                                 m3_comp_mins = as.numeric(difftime(as.POSIXct(ymd_hms(d_770257102)), as.POSIXct(ymd_hms(d_386488297)), units="hours"))*60,
                                 m4_comp_mins = as.numeric(difftime(as.POSIXct(ymd_hms(d_264644252)), as.POSIXct(ymd_hms(d_452942800)), units="hours"))*60)
all_data$Site <- factor(all_data$Site, levels=c("Baylor Scott and White Health","HealthPartners", "Henry Ford","Marshfield","Sanford","UChicago","KP Colorado","KP Georgia", "KP Hawaii","KP Northwest"))

```

 \newpage

```{r newTable1, echo=FALSE, warning=FALSE, message=FALSE, results='asis'}


comp_by_site <- all_data  %>% select(Site, BSL_compl) %>% 
  tbl_cross(col =BSL_compl,
                  row = Site, 
                   percent = "row",
                   digits= c(0,1),
                   label= c(Site~ "Site", BSL_compl ~ " "),
                   missing="ifany",
                   missing_text="0 ( 0 %)") 

comp_by_site_totals <- as.data.frame(comp_by_site)
comp_by_site_totals <- comp_by_site_totals[-1, ]

total_rows <- nrow(comp_by_site_totals)
knitr::kable(comp_by_site_totals , 
             caption='Table 1. Completion of Initial Surveys by Site', 
             row.names=FALSE,align=c("l","c","c","c"),
             col.names=c("", "All Completed", "One or More Not Completed", "Total"),
             booktabs = TRUE) %>%  
  add_indent(seq(1, total_rows - 1))  %>% 
  kable_styling(latex_options = c("scale_down","hold_position")) # %>%  column_spec(3:4, width = "4cm")


```


 
 \newpage
 
```{r Table2, echo=FALSE, warning=FALSE, message=FALSE}
#Make the automated table

all_srvy_comp <- all_data  %>% select(process, Recruit_Type) %>% 
  tbl_cross(  col =Recruit_Type,
                  row = process, 
                   percent = "column",
                   digits= c(0,1),
                   label= c(process~ "Sections Submitted", Recruit_Type ~ " "),
                   missing="ifany",
                   missing_text="0 ( 0 %)") 

all_srvy_comp_totals <- as.data.frame(all_srvy_comp)
all_srvy_comp_totals <- all_srvy_comp_totals[-1, ]
all_srvy_comp_totals <- all_srvy_comp_totals[c(9,5, 2:4,6:8, 1,10), ]





overall_surveys <- knitr::kable(all_srvy_comp_totals ,
                                col.names=c("Sections Submitted", "Active Verified","Passive Verified", "Total Verified"), 
                                caption='Table 2. Initial Survey Submission Among Verified Participants \n Stratified by Active and Passive Recruits', 
                                row.names=FALSE,align=c("l","c","c","c"), booktabs = TRUE) %>%  
  add_indent(seq(1, nrow(all_srvy_comp_totals) - 1))  %>%
  kable_styling(latex_options = c("scale_down","hold_position"))

add_footnote(overall_surveys, "Note: All sections were in MyConnect on July 5,2022. There were 766 verified participants beore that date.", notation = "none")

```


```{r Table3, echo=FALSE, warning=FALSE, message=FALSE}

calculate_counts <- function(df, column_name, row_label) {
  total_rows <- dim(df)[[1]]
  value_counts <- sapply(c(972455046, 615768760, 231311385), function(value) {
    count <- sum(df[[column_name]] == value)
    formatted_count <- formatC(count, format = "f", big.mark = ",", digits = 0)
    percentage <- round(100 * count / total_rows, 1)
    paste0(formatted_count, " (", percentage, "%)")
  })
  total_label <- paste(formatC(total_rows, format = "f", big.mark = ",", digits = 0), "(100%)")
  c(row_label, value_counts, total_label)
}


section_comp <- data.frame(matrix(ncol =5, nrow = 4))


section_comp[1, ] <- calculate_counts(all_data, "d_949302066", "BOH")
section_comp[2, ] <- calculate_counts(all_data, "d_536735468", "MRE")
section_comp[3, ] <- calculate_counts(all_data, "d_976570371", "SAS")
section_comp[4, ] <- calculate_counts(all_data, "d_663265240", "LAW")


colnames(section_comp) <- c("Section", "Not Started", "Started", "Submitted", "Total Verified Participants")


knitr::kable(section_comp, 
             caption='Table 3: Initial Survey Section Submission Status Among Verified Participants', 
             col.names=c("Section", "Not Started", "Started", "Submitted", "Total Verified Participants"), 
             row.names=FALSE, align=c("l","c","c","c","c"), booktabs = TRUE) %>% 
  kable_styling(latex_options = c("scale_down","hold_position"))


```






\newpage
\FloatBarrier


```{r Table4.1, echo=FALSE, error=FALSE, message=FALSE, warning=FALSE, results='asis'}


all_data <- all_data %>% group_by(Connect_ID) %>% mutate(last_mod_ts = max(d_832139544, d_770257102, d_264644252)) %>% ungroup()

all_data <- all_data %>% mutate(ver_M1 = as.numeric(difftime(as.POSIXct(ymd_hms(d_517311251)), as.POSIXct(ymd_hms(d_914594314)), units="hours")),
                                ver_M2 = as.numeric(difftime(as.POSIXct(ymd_hms(d_832139544)), as.POSIXct(ymd_hms(d_914594314)), units="hours")),
                                ver_M3 = as.numeric(difftime(as.POSIXct(ymd_hms(d_770257102)), as.POSIXct(ymd_hms(d_914594314)), units="hours")),
                                ver_M4 = as.numeric(difftime(as.POSIXct(ymd_hms(d_264644252)), as.POSIXct(ymd_hms(d_914594314)), units="hours")),
                                ver_last = as.numeric(difftime(as.POSIXct(ymd_hms(last_mod_ts)), as.POSIXct(ymd_hms(d_914594314)), units="hours")),
                                ver_M1_mins=ver_M1*60,
                                ver_M2_mins=ver_M2*60,
                                ver_M3_mins=ver_M3*60,
                                ver_M4_mins=ver_M4*60)


Table4a = all_data %>% group_by(Recruit_Type) %>% filter(d_949302066==231311385) %>% 
  dplyr::summarize('N'=n(),
                   Min = min(ver_M1, na.rm = TRUE),
                   Q1 = quantile(ver_M1, 0.25, na.rm = TRUE),
                   Median = median(ver_M1, na.rm = TRUE),
                   Mean = mean(ver_M1, na.rm = TRUE), 
                   SD= sd(ver_M1, na.rm = TRUE),
                   Q3 = quantile(ver_M1, 0.75, na.rm = TRUE),
                   'Perc.85' = quantile(ver_M1, 0.85, na.rm = TRUE),
                   'Perc.90' = quantile(ver_M1, 0.90, na.rm = TRUE),
                   'Perc.95' = quantile(ver_M1, 0.95, na.rm = TRUE),
                   Max = max(ver_M1, na.rm = TRUE)) 


Table4a2 = all_data %>% filter(d_949302066==231311385) %>% 
  dplyr::summarize('N'=n(),
                   Min = min(ver_M1, na.rm = TRUE),
                   Q1 = quantile(ver_M1, 0.25, na.rm = TRUE),
                   Median = median(ver_M1, na.rm = TRUE),
                   Mean = mean(ver_M1, na.rm = TRUE), 
                   SD= sd(ver_M1, na.rm = TRUE),
                   Q3 = quantile(ver_M1, 0.75, na.rm = TRUE),
                   'Perc.85' = quantile(ver_M1, 0.85, na.rm = TRUE),
                   'Perc.90' = quantile(ver_M1, 0.90, na.rm = TRUE),
                   'Perc.95' = quantile(ver_M1, 0.95, na.rm = TRUE),
                   Max = max(ver_M1, na.rm = TRUE)) 


Table4a1 <- Table4a #need to keep Table4a's first column name consistent to bind it later in the code
names(Table4a1)[1] <- "Recruit Type"





knitr::kable(Table4a1,format.args = list(big.mark = ","),
             caption='Table 4.1 Time (in hours) from Verification to BOH Submission \n Stratified by Active and Passive Recruits', 
             row.names=FALSE, align=c("l","c","c","c","c","c","c","c"),digits=2, booktabs = TRUE)%>% 
  kable_styling(latex_options = c("scale_down")) 


knitr::kable(Table4a2,format.args = list(big.mark = ","),
             caption='Table 4.2 Time (in hours) from Verification to BOH Submission for All Participants',
             row.names=FALSE, align=c("l","c","c","c","c","c","c","c"),digits=2, booktabs = TRUE)%>% 
  kable_styling(latex_options = c("scale_down","hold_position")) 
```


```{r Table5, echo=FALSE, error=FALSE, message=FALSE, warning=FALSE}




summarize_data <- function(data, filter_column, filter_value, target_column) {
  data %>% 
    filter(!!sym(filter_column) == filter_value) %>% 
    summarize('N' = n(),
              Min = min(!!sym(target_column), na.rm = TRUE),
              Q1 = quantile(!!sym(target_column), 0.25, na.rm = TRUE),
              Median = median(!!sym(target_column), na.rm = TRUE),
              Mean = mean(!!sym(target_column), na.rm = TRUE), 
              SD = sd(!!sym(target_column), na.rm = TRUE),
              Q3 = quantile(!!sym(target_column), 0.75, na.rm = TRUE),
              'Perc.85' = quantile(!!sym(target_column), 0.85, na.rm = TRUE),
              'Perc.90' = quantile(!!sym(target_column), 0.90, na.rm = TRUE),
              'Perc.95' = quantile(!!sym(target_column), 0.95, na.rm = TRUE),
              Max = max(!!sym(target_column), na.rm = TRUE))
}


Table4b <- summarize_data(all_data, "d_536735468", 231311385, "ver_M2")
Table4c <- summarize_data(all_data, "d_976570371", 231311385, "ver_M3")
Table4d <- summarize_data(all_data, "d_663265240", 231311385, "ver_M4")
Table4e <- summarize_data(all_data, "d_100767870", 353358909, "ver_last")



### Table4a2 in previous chunk
tb5boh <- as.data.frame(Table4a2)
table4 <- rbind(tb5boh, Table4b, Table4c, Table4d, Table4e)



table4<- table4[, c(1:7, 9, 11)]
table4[,10] <- c("BOH", "MRE", "SAS", "LAW", "All")
table4<- table4[, c(10,1:9)]
colnames(table4)[1] <- "Section"


knitr::kable(table4,format.args = list(big.mark = ","),
             caption='Table 5. Time (in hours) from Verification to Initial Survey Module Submission',
             row.names=FALSE, align=c("l","c","c","c","c","c","c","c"),digits=2, booktabs = TRUE)%>% 
  kable_styling(latex_options = c("scale_down","hold_position")) 

```



\FloatBarrier





\newpage



```{r Submission_Minutes,echo=FALSE,error=FALSE,message=FALSE,warning=FALSE,results='asis'}



process_module <- function(data, start_time, end_time, completion_flag, completion_status, module_name) {
  
  
  data <- data %>%
    filter(!!sym(completion_flag) == completion_status)
  
  
  comp_tm <- as.numeric(difftime(as.POSIXct(ymd_hms(data[[start_time]])), 
                                 as.POSIXct(ymd_hms(data[[end_time]])), 
                                 units = "hours"))
  
  
  data <- data %>%
    mutate(comp_mins = comp_tm * 60,
           time_frame = case_when(
             comp_mins < 5 ~ "Under 5 minutes",
             comp_mins < 10 ~ "5 to 10 minutes",
             comp_mins < 15 ~ "10 to 15 minutes",
             comp_mins < 20 ~ "15 to 20 minutes",
             comp_mins < 30 ~ "20 to 30 minutes",
             comp_mins < 45 ~ "30 to 45 minutes",
             comp_mins < 60 ~ "45 to 60 minutes",
             comp_mins >= 60 ~ "60 minutes+",
             is.na(data[[start_time]]) | is.na(data[[end_time]]) ~ "Missing Time Stamp(s)"
           ))
  
  data$time_frame <- factor(data$time_frame, levels = c(
    "Under 5 minutes", "5 to 10 minutes", "10 to 15 minutes",
    "15 to 20 minutes", "20 to 30 minutes", "30 to 45 minutes",
    "45 to 60 minutes", "60 minutes+", "Missing Time Stamp(s)"
  ))
  
  summary_data <- data %>%
    group_by(time_frame) %>%
    summarize(n = n(), percentage = 100 * n / nrow(data)) %>%
    ungroup() %>%
    mutate(cumulative_percentage = cumsum(percentage)) %>%
    select(time_frame, n, percentage, cumulative_percentage)
  
  summary_row <- summary_data %>%
    summarize(n = sum(n), percentage = 100, 
              cumulative_percentage = 100,
              time_frame = "Total")
  
  summary_data <- bind_rows(summary_data, summary_row)
  
  table_summary <- summary_data %>%
    mutate(np = paste0(n, " (", round(percentage, digits = 2), "%)"),
           cumulative_percentage = paste0(round(cumulative_percentage, digits = 2), "%")) %>%
    select(time_frame, np, cumulative_percentage)
  
  knitr::kable(table_summary, 
               caption = paste0('Table ', module_name, ' Section Initial Survey Submission Time \n from Start to Submit for Verified Participants'), 
               col.names = c("Submission Time", "Total Participants", "Cumulative Percentage"), 
               row.names = FALSE, align = c("l", "c"), digits = 1, booktabs = TRUE) %>%  
    add_indent(seq(1, nrow(table_summary) - 1)) %>% 
    kable_styling(latex_options = "scale_down") #c("scale_down","hold_position"))
}


table6.1_sum <- process_module(all_data, "d_517311251", "d_205553981", "d_949302066", 231311385, "6.1 BOH")
table6.2_sum <- process_module(all_data, "d_832139544", "d_541836531", "d_536735468", 231311385, "6.2 MRE")
table6.3_sum <- process_module(all_data, "d_770257102", "d_386488297", "d_976570371", 231311385, "6.3 SAS")
table6.4_sum <- process_module(all_data, "d_264644252", "d_452942800", "d_663265240", 231311385, "6.4 LAW")

table6.1_sum
table6.2_sum
table6.3_sum
table6.4_sum


```

\FloatBarrier

```{r Table7,echo=FALSE,error=FALSE,message=FALSE,warning=FALSE,results='asis'}



summarize_data <- function(data, filter_column, filter_value, target_column) {
  data %>% 
    filter(!!sym(filter_column) == filter_value) %>% 
    summarize('N' = n(),
              Min = min(!!sym(target_column), na.rm = TRUE),
              Q1 = quantile(!!sym(target_column), 0.25, na.rm = TRUE),
              Median = median(!!sym(target_column), na.rm = TRUE),
              Mean = mean(!!sym(target_column), na.rm = TRUE), 
              SD = sd(!!sym(target_column), na.rm = TRUE),
              Q3 = quantile(!!sym(target_column), 0.75, na.rm = TRUE),
              'Perc.85' = quantile(!!sym(target_column), 0.85, na.rm = TRUE),
              'Perc.90' = quantile(!!sym(target_column), 0.90, na.rm = TRUE),
              'Perc.95' = quantile(!!sym(target_column), 0.95, na.rm = TRUE),
              Max = max(!!sym(target_column), na.rm = TRUE))
}

Table7a <- summarize_data(all_data, "d_949302066", 231311385, "m1_comp_mins")
Table7b <- summarize_data(all_data, "d_536735468", 231311385, "m2_comp_mins")
Table7c <- summarize_data(all_data, "d_976570371", 231311385, "m3_comp_mins")
Table7d <- summarize_data(all_data, "d_663265240", 231311385, "m4_comp_mins")


Table7 <- rbind(Table7a, Table7b, Table7c, Table7d)


Table7<- Table7[, c(1:7, 9, 11)]
Table7[,10] <- c("BOH", "MRE", "SAS", "LAW")
Table7<- Table7[, c(10,1:9)]
colnames(Table7)[1] <- "Section"


knitr::kable(Table7,format.args = list(big.mark = ","),
             caption='Table 7. Time (in minutes) from Start to Submit of Initial Survey Modules',
             row.names=FALSE, align=c("l","c","c","c","c","c","c","c"),digits=2, booktabs = TRUE)%>% 
  kable_styling(latex_options = c("scale_down","hold_position")) 


```








```{r Section8, echo=FALSE, warning = FALSE}



cannot_ver <- data_c %>%  filter(d_821247024==219863910 & d_512820379==486306141) %>%  
  mutate(sect_comp= case_when((d_949302066==231311385 | d_536735468==231311385 | d_976570371==231311385 | d_663265240==231311385) ~ "At Least One",
                              TRUE ~ "None"))

Numb5 <- cannot_ver %>% group_by(sect_comp) %>%    dplyr::summarize(n=n(), percentage=100*n/nrow(.))  %>% dplyr::ungroup() %>%  dplyr::select(sect_comp, n, percentage)

Numb5_table <- Numb5 %>% mutate(np = paste0(n, " (", round(percentage, digits=2), "%)")) %>% select(sect_comp, np)

Numb5_table[dim(Numb5_table)[[1]]+1 , ] <- list("Total", paste(sum(Numb5$n), " (100%)"))


knitr::kable(Numb5_table, 
             caption='Table 8. Inital Survey Submission Status among Active Recruits who Could Not be Verified', 
             col.names=c("Sections Submitted", "Active recruits"), 
             row.names=FALSE, align=c("l","c"),digits=1, booktabs = TRUE) %>%  
  add_indent(c(1:2)) %>% 
  kable_styling(latex_options = "scale_down")


```


\newpage

```{r Menstrual_BQPull, include=FALSE}


mens_ccc <- "WITH combined_survey AS (
  SELECT Connect_ID
  FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.bioSurvey_v1_JP`
  WHERE d_112151599 = '353358909'

  UNION DISTINCT

  SELECT Connect_ID
  FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.clinicalBioSurvey_v1_JP`
  WHERE d_112151599 = '353358909'
)

SELECT p.Connect_ID, p.d_459098666, p.d_253883960, p.d_265193023
FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP` p
JOIN combined_survey c ON p.Connect_ID = c.Connect_ID
WHERE (p.d_253883960 = '231311385' OR p.d_265193023 = '231311385')"


mens_table_cc <- bq_project_query(project, mens_ccc)
menstrual <- bq_table_download(mens_table_cc, bigint = "integer64")
```

```{r Menstrual, echo=FALSE, warning = FALSE, message=FALSE}
mens_surv <- menstrual %>%  mutate(menst=case_when(d_459098666==231311385~"Submitted",
                                                   d_459098666==615768760~"Started",
                                                   d_459098666==972455046~"Not Started"),
                                setting= case_when(d_265193023=='231311385' ~ "Among Research Collections",
                                                   d_253883960=='231311385' ~ "Among Clinical Collections")) %>% 
      tbl_cross(
    row = menst,
    col =setting,
    digits=c(0,1),
    percent = "column",
    label=list(menst="Submission Status",
                setting = " "),
    missing="ifany",
    margin_text="Total") 


mens_surv_status <- 
  mens_surv %>%
  #bold_labels() %>%
  #italicize_levels() %>%
  modify_header(stat_0 = "Total") %>%
  modify_caption("Table 9. Menstrual Cycle Survey Submission Status for Eligible Participants") %>%
  as_kable_extra(escape = FALSE, addtl_fmt = TRUE)

add_footnote(mens_surv_status, "Note: Eligible participants are those that completed the Clinical Biospecimen Blood and Urine Survey or the Research Biospecimen Blood, Urine and Mouthwash survey. On that survey they must also have answered yes to MENST60, indicating that they have had a menstrual period in the last 60 days.", notation = "none")


```





```{r SSN, echo=FALSE, warning=FALSE, message=FALSE, results='asis'}


ssn_surv = all_data %>%  mutate(provided4 =case_when(d_311580100==353358909 ~ "Full SSN",
                                                     d_914639140==353358909 ~ "Partial SSN",
                                                     TRUE ~ "No SSN"))
ssn_surv$provided4<- factor(ssn_surv$provided4,levels=c("Full SSN", "Partial SSN", "No SSN"))

ssn_surv = ssn_surv %>% mutate(started=case_when(d_126331570==615768760 ~ "Started",
                           d_126331570==231311385 ~ "Submitted",
                           TRUE ~ "Not Started"))



 
ssn_surv %>% tbl_cross(
    row = started,
    col =provided4,
    digits=c(0,1),
    percent = "row",
    label=list(started="Submission Status",
                provided4 = "Portion of SSN Given"),
    missing="ifany",
    margin_text="Total") %>% 


# ssn_surv %>%
#   #bold_labels() %>%
  #italicize_levels() %>%
  modify_header(stat_0 = "Total") %>%
  modify_caption("Table 10. Portion of SSN Given by Submission Status of SSN Survey") %>%
  as_kable_extra(escape = FALSE, addtl_fmt = TRUE)

```

\newpage
\FloatBarrier
```{r Table11s, echo=FALSE, warning=FALSE, message=FALSE, results='asis'}



####### ALL 
QOL_comp_elg <- all_data %>% filter(qolcomplt!="Not Eligible") %>% 
  mutate(qolcomplt = factor(qolcomplt, levels=c("Not Started", "Started", "Submitted"))) %>% 
  select(Site, qolcomplt) %>% dplyr::arrange(Site,qolcomplt) %>% 
  tbl_cross(
  row = Site,
  col = qolcomplt,
  label = list(qolcomplt ~ "Survey Completion",Site~"Site"),
  percent = "row",
  digits=c(0,2),
  margin_text="Total QOL Eligible Participants") 

QOL_comp_elg[["table_body"]]$stat_0 <- sapply(strsplit(QOL_comp_elg[["table_body"]]$stat_0," "),"[",1)

QOL_comp_elg <- QOL_comp_elg %>%
  #bold_labels() %>%
  #italicize_levels() %>% 
  modify_header(stat_0 = "Total QOL Eligible \n Participants") %>%
  modify_caption("Table 11. Completion of 3-Month Quality of Life Survey Among Eligible Participants") %>%
  as_kable_extra(escape = FALSE, addtl_fmt = TRUE)

 
QOL_comp_elg %>% kable_styling(latex_options = c("scale_down","hold_position"))




##### verified on or after 12/1/23

QOL_comp_elg_after <- all_data %>% filter(qolcomplt!="Not Eligible" & as.Date(d_914594314) >= "2023-12-01") %>% 
  mutate(qolcomplt = factor(qolcomplt, levels=c("Not Started", "Started", "Submitted"))) %>% 
  select(Site, qolcomplt) %>% dplyr::arrange(Site,qolcomplt) %>% 
  tbl_cross(
  row = Site,
  col = qolcomplt,
  label = list(qolcomplt ~ "Survey Completion",Site~"Site"),
  percent = "row",
  digits=c(0,2),
  margin_text="Total QOL Eligible Participants") 

QOL_comp_elg_after[["table_body"]]$stat_0 <- sapply(strsplit(QOL_comp_elg_after[["table_body"]]$stat_0," "),"[",1)

 QOL_comp_elg_after <- QOL_comp_elg_after %>%
  #bold_labels() %>%
  #italicize_levels() %>% 
  modify_header(stat_0 = "Total QOL Eligible \n Participants") %>%
  modify_caption("Table 11.a. Completion of 3-Month Quality of Life Survey among Eligible participants Verified on or after December 1, 2023") %>%
  as_kable_extra(escape = FALSE, addtl_fmt = TRUE)

QOL_comp_elg_after %>% kable_styling(latex_options = c("scale_down","hold_position")) 





###### verified before 12/1/23
QOL_comp_elg_before <- all_data %>% filter(qolcomplt!="Not Eligible" & as.Date(d_914594314) < "2023-12-01") %>% 
  mutate(qolcomplt = factor(qolcomplt, levels=c("Not Started", "Started", "Submitted"))) %>% 
  select(Site, qolcomplt) %>% dplyr::arrange(Site,qolcomplt) %>% 
  tbl_cross(
  row = Site,
  col = qolcomplt,
  label = list(qolcomplt ~ "Survey Completion",Site~"Site"),
  percent = "row",
  digits=c(0,2),
  margin_text="Total QOL Eligible Participants") 

QOL_comp_elg_before[["table_body"]]$stat_0 <- sapply(strsplit(QOL_comp_elg_before[["table_body"]]$stat_0," "),"[",1)

QOL_comp_elg_before <- QOL_comp_elg_before %>%
  #bold_labels() %>%
  #italicize_levels() %>% 
  modify_header(stat_0 = "Total QOL Eligible \n Participants") %>%
  modify_caption("Table 11.b. Completion of 3-Month Quality of Life Survey among Eligible Participants Verified prior to December 1, 2023") %>%
  as_kable_extra(escape = FALSE, addtl_fmt = TRUE)


QOL_comp_elg_before %>% kable_styling(latex_options = c("scale_down","hold_position")) %>% 
  footnote(general = 'The QOL "PROMIS" or "QOL" survey was released to all those verified prior to December 1, 2023 on August 30, 2024.',general_title = "Note: ", footnote_as_chunk = T)

```


\newpage
\FloatBarrier

```{r Table12s, echo=FALSE, warning=FALSE, message=FALSE, results='asis'}

###### ALL ########
QOL_comp_BL <- all_data %>%  filter(qolcomplt!="Not Eligible") %>%  
  mutate(qolcomplt = factor(qolcomplt, levels=c("Not Started", "Started", "Submitted")),
         completion = factor(completion, levels=c("Completed all baseline survey modules 1-4, no baseline samples", "Completed any baseline sample, did not complete baseline survey",
                                                          "Completed both survey and sample(s)", "Completed neither survey or sample(s)"))) %>% 
  select(completion, qolcomplt) %>% dplyr::arrange(completion,qolcomplt) %>% tbl_cross(
  row = completion,
  col = qolcomplt,
  label = list(qolcomplt ~ "Survey Completion",completion~"Completion"),
  percent = "row",
  digits=c(0,2),
  margin_text="Total QOL Eligible Participants") 

#QOL_comp_BL[["table_body"]]$stat_0 <- sapply(strsplit(QOL_comp_BL[["table_body"]]$stat_0," "),"[",1)



QOL_comp_BL <- QOL_comp_BL %>%
  #bold_labels() %>%
  #italicize_levels() %>% 
  modify_header(stat_0 = "Total QOL Eligible \n Participants") %>%
  modify_caption("Table 12. Completion of 3-Month Quality of Life Survey by Baseline Data Completeness") %>%
  as_kable_extra(escape = FALSE, addtl_fmt = TRUE)

QOL_comp_BL %>% kable_styling(latex_options = c("scale_down","hold_position"))


###### On or After 12/1/23 ########

QOL_comp_BL_after <- all_data %>% filter(as.Date(d_914594314) >= "2023-12-01" & qolcomplt!="Not Eligible") %>% 
  mutate(completion = factor(completion, levels=c("Completed all baseline survey modules 1-4, no baseline samples", "Completed any baseline sample, did not complete baseline survey",
                                                          "Completed both survey and sample(s)", "Completed neither survey or sample(s)")),
         qolcomplt = factor(qolcomplt, levels=c("Not Started", "Started", "Submitted"))) %>% 
  select(completion, qolcomplt) %>% dplyr::arrange(completion,qolcomplt) %>% tbl_cross(
  row = completion,
  col = qolcomplt,
  label = list(qolcomplt ~ "Survey Completion",completion~"Completion"),
  percent = "row",
  digits=c(0,2),
  margin_text="Total QOL Eligible Participants")

 QOL_comp_BL_after <- QOL_comp_BL_after %>%
  #bold_labels() %>%
  #italicize_levels() %>% 
  modify_header(stat_0 = "Total QOL Eligible \n Participants") %>%
  modify_caption("Table 12.a. Completion of 3-Month Quality of Life Survey by Baseline Data Completeness among Eligible Participants Verified on or after December 1, 2023") %>%
  as_kable_extra(escape = FALSE, addtl_fmt = TRUE)

QOL_comp_BL_after %>% kable_styling(latex_options = c("scale_down","hold_position"))


###### Before 12/1/23 ########

QOL_comp_BL_before <- all_data %>% filter(as.Date(d_914594314) < "2023-12-01" & qolcomplt!="Not Eligible") %>% 
  mutate(completion = factor(completion, levels=c("Completed all baseline survey modules 1-4, no baseline samples", "Completed any baseline sample, did not complete baseline survey",
                                                          "Completed both survey and sample(s)", "Completed neither survey or sample(s)")),
         qolcomplt = factor(qolcomplt, levels=c("Not Started", "Started", "Submitted"))) %>% 
  select(completion, qolcomplt) %>% dplyr::arrange(completion,qolcomplt) %>% tbl_cross(
  row = completion,
  col = qolcomplt,
  label = list(qolcomplt ~ "Survey Completion",completion~"Completion"),
  percent = "row",
  digits=c(0,2),
  margin_text="Total QOL Eligible Participants")

QOL_comp_BL_before <- QOL_comp_BL_before%>%
  #bold_labels() %>%
  #italicize_levels() %>% 
  modify_header(stat_0 = "Total QOL Eligible \n Participants") %>%
  modify_caption("Table 12.b. Completion of 3-Month Quality of Life Survey by Baseline Data Completeness among Eligible Participants Verified on before December 1, 2023") %>%
  as_kable_extra(escape = FALSE, addtl_fmt = TRUE)

QOL_comp_BL_before %>% kable_styling(latex_options = c("scale_down","hold_position"))

```





```{r Overall_BySex_ByAge, echo=FALSE, warning=FALSE, message=FALSE, results='asis'}


Comp_by_Sex <- all_data %>% filter(qolcomplt!="Not Eligible") %>% 
  mutate(qolcomplt = factor(qolcomplt, levels=c("Not Started", "Started", "Submitted"))) %>% 
  select(sex, qolcomplt) %>% dplyr::arrange(sex,qolcomplt) %>% 
  tbl_cross(
  row = sex,
  col = qolcomplt,
  label = list(qolcomplt ~ "Survey Completion",sex~"Sex"),
  percent = "row",
  digits=c(0,2),
  margin_text="Total QOL Eligible Participants") 


Comp_by_Sex_table <- Comp_by_Sex %>%
  #bold_labels() %>%
  #italicize_levels() %>% 
  modify_header(stat_0 = "Total QOL Eligible \n Participants") %>%
  modify_caption("Table 13. 3-Month Quality of Life Survey Completion Rate by Site Defined Sex \n Among Eligible Participants") %>%
  as_kable_extra(escape = FALSE, addtl_fmt = TRUE)

 
Comp_by_Sex_table %>% kable_styling(latex_options = c("scale_down","hold_position"))







Comp_by_Age <- all_data %>% filter(qolcomplt!="Not Eligible") %>% 
  mutate(qolcomplt = factor(qolcomplt, levels=c("Not Started", "Started", "Submitted"))) %>% 
  select(age, qolcomplt) %>% dplyr::arrange(age,qolcomplt) %>% 
  tbl_cross(
  row = age,
  col = qolcomplt,
  label = list(qolcomplt ~ "Survey Completion",age~"Age"),
  percent = "row",
  digits=c(0,2),
  margin_text="Total QOL Eligible Participants") 

#Comp_by_Age[["table_body"]]$stat_0 <- sapply(strsplit(Comp_by_Age[["table_body"]]$stat_0," "),"[",1)

Comp_by_Age <- Comp_by_Age %>%
  #bold_labels() %>%
  #italicize_levels() %>% 
  modify_header(stat_0 = "Total QOL Eligible \n Participants") %>%
  modify_caption("Table 14. 3-Month Quality of Life Survey Completion Rate by Age \n Among Eligible Participants") %>%
  as_kable_extra(escape = FALSE, addtl_fmt = TRUE)

 
Comp_by_Age %>% kable_styling(latex_options = c("scale_down","hold_position"))


```


```{r merge1, include=FALSE, warning=FALSE}

dictionary <- rio::import("https://episphere.github.io/conceptGithubActions/aggregate.json",format = "json")
dd <- dplyr::bind_rows(dictionary,.id="CID")
dd <-rbindlist(dictionary,fill=TRUE,use.names=TRUE,idcol="CID")
dd$`Variable Label`[is.na(dd$`Variable Label`)] <- replace_na(dd$'Variable Name')

dd <- as.data.frame.matrix(do.call("rbind",dictionary)) 
dd$CID <- rownames(dd)
#https://shaivyakodan.medium.com/7-useful-r-packages-for-analysis-7f60d28dca98
#devtools::install_github("tidyverse/reprex")


recr_M1 <- bq_project_query(project, query="SELECT token,Connect_ID, d_821247024, d_914594314,  d_827220437,d_512820379,
                            d_949302066 , d_517311251  FROM  `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP` WHERE  d_821247024='197316935'")
recr_m1 <- bq_table_download(recr_M1,bigint = "integer64",n_max = Inf, page_size = 10000)
cnames <- names(recr_m1)
# Check that it doesn't match any non-number
numbers_only <- function(x) !grepl("\\D", x)
# to check variables in recr_noinact_wl1
for (i in 1: length(cnames)){
  varname <- cnames[i]
  var<-pull(recr_m1,varname)
  recr_m1[,cnames[i]] <- ifelse(numbers_only(var), as.numeric(as.character(var)), var)
}

sql_M1_1 <- bq_project_query(project, query="SELECT Connect_ID, D_384191091_D_384191091_D_583826374, D_384191091_D_384191091_D_636411467, D_384191091_D_384191091_D_458435048, D_384191091_D_384191091_D_706998638, D_384191091_D_384191091_D_973565052, D_384191091_D_384191091_D_586825330, D_384191091_D_384191091_D_412790539, D_384191091_D_384191091_D_807835037,D_384191091_D_747350323,D_384191091_D_384191091_D_746038746 FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.module1_v1_JP` where Connect_ID is not null")
sql_M1_2 <- bq_project_query(project, query="SELECT Connect_ID, D_384191091_D_384191091_D_583826374 ,D_384191091_D_384191091_D_636411467, D_384191091_D_384191091_D_458435048, D_384191091_D_384191091_D_706998638, D_384191091_D_384191091_D_973565052, D_384191091_D_384191091_D_586825330,D_384191091_D_384191091_D_412790539,D_384191091_D_384191091_D_807835037,D_384191091_D_747350323,D_384191091_D_384191091_D_746038746 FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.module1_v2_JP` where Connect_ID is not null")


M1_V1 <- bq_table_download(sql_M1_1,bigint = "integer64",n_max = Inf) #1436 #1436 vars: 1507 01112023 
M1_V2 <- bq_table_download(sql_M1_2,bigint = "integer64",n_max = Inf) #2333 #3033 01112023 var:1531 #6339 obs 1893 vars 05022023

mod1_v1 <- M1_V1
cnames <- names(M1_V1)
###to check variables and convert to numeric
for (i in 1: length(cnames)){
  varname <- cnames[i]
  var<-pull(mod1_v1,varname)
  mod1_v1[,cnames[i]] <- ifelse(numbers_only(var), as.numeric(as.character(var)), var)
}
mod1_v2 <- M1_V2
cnames <- names(M1_V2)
###to check variables and convert to numeric
for (i in 1: length(cnames)){
  varname <- cnames[i]
  var<-pull(mod1_v2,varname)
  mod1_v2[,cnames[i]] <- ifelse(numbers_only(var), as.numeric(as.character(var)), var)
}

M1_V1.var <- colnames(M1_V1)
M1_V2.var <- colnames(M1_V2)
var.matched <- M1_V1.var[which(M1_V1.var %in% M1_V2.var)]
length(var.matched)  #1275 #1278 vars 01112023 #1348 vars 05022023

V1_only_vars <- colnames(M1_V1)[colnames(M1_V1) %nin% var.matched] #232 #229 01112023 #159 05022023
V2_only_vars <- colnames(M1_V2)[colnames(M1_V2) %nin% var.matched] #253 #253 01112023 #545 05022023

length(M1_V1$Connect_ID[M1_V1$Connect_ID %in% M1_V2$Connect_ID])
#[1] 59 with the completion of two versions of Module1 
#[1] 62 with completing both versions of M1 ###double checked 03/28/2023
#68 double checked 05/02/2023

common.IDs <- M1_V1$Connect_ID[M1_V1$Connect_ID %in% M1_V2$Connect_ID]
M1_V1_common <- mod1_v1[,var.matched]

M1_V2_common <- mod1_v2[,var.matched]
M1_V1_common$version <- 1
M1_V2_common$version <- 2

##to check the completion of M1 among these duplicates
partM1_dups <- recr_m1[which(recr_m1$Connect_ID %in% common.IDs),]
table(partM1_dups$d_949302066)

M1_common  <- rbind(M1_V1_common, M1_V2_common) #including 136 duplicates (version 1 and version 2) from 68 participants 05022023
#M1_response <- matrix(data=NA, nrow=118, ncol=967)

m1_v1_only <- mod1_v1[,c("Connect_ID", V1_only_vars)] #230 vars 03282023 #160 vars 05/02/2023
m1_v2_only <- mod1_v2[,c("Connect_ID", V2_only_vars)] #255 vars 03282023 #546 vars 05/02/2023
m1_v1_only$version <- 1
m1_v2_only$version <- 2
#for (i in 1:length)
##to check the completion in each version
length(recr_m1$Connect_ID[which(recr_m1$Connect_ID %in% m1_v1_only$Connect_ID & recr_m1$d_949302066 ==231311385)]) #1364 03282023 # 1370 05022023
length(recr_m1$Connect_ID[which(recr_m1$Connect_ID %in% m1_v2_only$Connect_ID & recr_m1$d_949302066 ==231311385)]) #4870 03282023 # 5731 05022023

#library(janitor)

m1_common <- rbind(M1_V1_common,M1_V2_common)
m1_common_v1 <- base::merge(m1_common, m1_v1_only, by=c("Connect_ID","version"),all.x=TRUE)
m1_combined_v1v2 <- base::merge(m1_common_v1,m1_v2_only,by=c("Connect_ID","version"),all.x=TRUE)
m1_complete <- m1_combined_v1v2[which(m1_combined_v1v2$Connect_ID %in% recr_m1$Connect_ID[which(recr_m1$d_949302066 ==231311385 )]),] #7289 including duplicates 05022023

m1_complete <- m1_complete %>% arrange(desc(version)) 


m1_complete_nodup <- m1_complete[!duplicated(m1_complete$Connect_ID),] 
table(m1_complete_nodup$version)




all_data$Connect_ID <- as.numeric(all_data$Connect_ID)


promis_df= left_join(m1_complete_nodup, all_data, by="Connect_ID")
dim(promis_df)


promis <- as_tibble(promis_df)


knitr::opts_chunk$set(comment = NA)

```



```{r Race, warning=FALSE, echo=FALSE, message=FALSE}


## Multi-racial

multi_race=0    
for (i in 1:length(promis$Connect_ID)){
  AI=ifelse((promis$D_384191091_D_384191091_D_583826374[[i]]==1 & (promis$D_384191091_D_384191091_D_636411467[[i]]==1 | promis$D_384191091_D_384191091_D_458435048[[i]]==1|
                                               promis$D_384191091_D_384191091_D_706998638[[i]]==1 | promis$D_384191091_D_384191091_D_973565052[[i]]==1 |
                                               promis$D_384191091_D_384191091_D_586825330[[i]]==1 | promis$D_384191091_D_384191091_D_412790539[[i]]==1 |
                                               promis$D_384191091_D_384191091_D_807835037[[i]]==1)), 1, 0)
  As=ifelse((promis$D_384191091_D_384191091_D_636411467[[i]]==1 & (promis$D_384191091_D_384191091_D_583826374[[i]]==1 | promis$D_384191091_D_384191091_D_458435048[[i]]==1|
                                                        promis$D_384191091_D_384191091_D_706998638[[i]]==1 | promis$D_384191091_D_384191091_D_973565052[[i]]==1 |
                                                        promis$D_384191091_D_384191091_D_586825330[[i]]==1 | promis$D_384191091_D_384191091_D_412790539[[i]]==1 |
                                                        promis$D_384191091_D_384191091_D_807835037[[i]]==1)), 1, 0)
  Bl=ifelse((promis$D_384191091_D_384191091_D_458435048[[i]]==1 & (promis$D_384191091_D_384191091_D_583826374[[i]]==1 | promis$D_384191091_D_384191091_D_636411467[[i]]==1|
                                                        promis$D_384191091_D_384191091_D_706998638[[i]]==1 | promis$D_384191091_D_384191091_D_973565052[[i]]==1 |
                                                        promis$D_384191091_D_384191091_D_586825330[[i]]==1 | promis$D_384191091_D_384191091_D_412790539[[i]]==1 |
                                                        promis$D_384191091_D_384191091_D_807835037[[i]]==1)), 1, 0)
  Hs=ifelse((promis$D_384191091_D_384191091_D_706998638[[i]]==1 & (promis$D_384191091_D_384191091_D_583826374[[i]]==1 | promis$D_384191091_D_384191091_D_636411467[[i]]==1|
                                                        promis$D_384191091_D_384191091_D_458435048[[i]]==1 | promis$D_384191091_D_384191091_D_973565052[[i]]==1 |
                                                        promis$D_384191091_D_384191091_D_586825330[[i]]==1 | promis$D_384191091_D_384191091_D_412790539[[i]]==1 |
                                                        promis$D_384191091_D_384191091_D_807835037[[i]]==1)), 1, 0)
  Me=ifelse((promis$D_384191091_D_384191091_D_973565052[[i]]==1 & (promis$D_384191091_D_384191091_D_583826374[[i]]==1 | promis$D_384191091_D_384191091_D_636411467[[i]]==1|
                                                        promis$D_384191091_D_384191091_D_458435048[[i]]==1 | promis$D_384191091_D_384191091_D_706998638[[i]]==1 |
                                                        promis$D_384191091_D_384191091_D_586825330[[i]]==1 | promis$D_384191091_D_384191091_D_412790539[[i]]==1 |
                                                        promis$D_384191091_D_384191091_D_807835037[[i]]==1)), 1, 0)
  Hw=ifelse((promis$D_384191091_D_384191091_D_586825330[[i]]==1 & (promis$D_384191091_D_384191091_D_583826374[[i]]==1 | promis$D_384191091_D_384191091_D_636411467[[i]]==1|
                                                        promis$D_384191091_D_384191091_D_458435048[[i]]==1 | promis$D_384191091_D_384191091_D_706998638[[i]]==1 |
                                                        promis$D_384191091_D_384191091_D_973565052[[i]]==1 | promis$D_384191091_D_384191091_D_412790539[[i]]==1 |
                                                        promis$D_384191091_D_384191091_D_807835037[[i]]==1)), 1, 0)
  Wh=ifelse((promis$D_384191091_D_384191091_D_412790539[[i]]==1 & (promis$D_384191091_D_384191091_D_583826374[[i]]==1 | promis$D_384191091_D_384191091_D_636411467[[i]]==1|
                                                        promis$D_384191091_D_384191091_D_458435048[[i]]==1 | promis$D_384191091_D_384191091_D_706998638[[i]]==1 |
                                                        promis$D_384191091_D_384191091_D_586825330[[i]]==1 | promis$D_384191091_D_384191091_D_973565052[[i]]==1 |
                                                        promis$D_384191091_D_384191091_D_807835037[[i]]==1)), 1, 0)
  Ot=ifelse((promis$D_384191091_D_384191091_D_807835037[[i]]==1 & (promis$D_384191091_D_384191091_D_583826374[[i]]==1 | promis$D_384191091_D_384191091_D_636411467[[i]]==1|
                                                        promis$D_384191091_D_384191091_D_458435048[[i]]==1 | promis$D_384191091_D_384191091_D_706998638[[i]]==1 |
                                                        promis$D_384191091_D_384191091_D_586825330[[i]]==1 | promis$D_384191091_D_384191091_D_973565052[[i]]==1 |
                                                        promis$D_384191091_D_384191091_D_412790539[[i]]==1)), 1, 0)
  multi_race= multi_race + sum(AI+As+Bl+Hs+Me+Hw+Wh+Ot, na.rm=T)

}

#cat("Percentage of multirace participants:", (multi_race/(dim(promis)[1]))*100)
   
   

promis$multi_racial <- c(rep(1, times=multi_race), rep(0, times=(dim(promis)[1]- multi_race)))



## RACE

promis = promis %>%  mutate(race= case_when(multi_racial==1 ~ "Multi-Racial",
                                                     D_384191091_D_384191091_D_583826374==1 ~ "American Indian or Native American",
                                                     D_384191091_D_384191091_D_636411467==1 ~ "Asian/Asian American",
                                                     D_384191091_D_384191091_D_458435048==1 ~ "Black, African American, or African",
                                                     D_384191091_D_384191091_D_706998638==1 ~ "Hispanic, Latino, or Spanish",
                                                     D_384191091_D_384191091_D_973565052==1 ~ "Middle Eastern or North African",
                                                     D_384191091_D_384191091_D_586825330==1 ~ "Hawaiian or Pacific Islander",
                                                     D_384191091_D_384191091_D_412790539==1 ~ "White",
                                                     (D_384191091_D_384191091_D_807835037==1 | !is.na(D_384191091_D_747350323)) ~ "Other",
                                                     D_384191091_D_384191091_D_746038746==1 ~ "Prefer Not to Answer",
                                                     TRUE  ~ "Skipped this question"))

```




```{r By_Race, echo=FALSE, warning=FALSE, message=FALSE, results='asis'}


Comp_by_race <- promis %>% filter(qolcomplt!="Not Eligible") %>% 
  mutate(qolcomplt = factor(qolcomplt, levels=c("Not Started", "Started", "Submitted"))) %>% 
  select(race, qolcomplt) %>% dplyr::arrange(race,qolcomplt) %>% 
  tbl_cross(
  row = race,
  col = qolcomplt,
  label = list(qolcomplt ~ "Survey Completion",race~"Race"),
  percent = "row",
  digits=c(0,2),
  margin_text="Total QOL Eligible Participants") 

#Comp_by_race[["table_body"]]$stat_0 <- sapply(strsplit(Comp_by_race[["table_body"]]$stat_0," "),"[",1)

Comp_by_race <- Comp_by_race %>%
  #bold_labels() %>%
  #italicize_levels() %>% 
  modify_header(stat_0 = "Total QOL Eligible \n Participants") %>%
  modify_caption("Table 15. 3-Month Quality of Life Survey Completion Rate by Race \n Among Eligible Participants") %>%
  as_kable_extra(escape = FALSE, addtl_fmt = TRUE)

reduced <- all_data %>% filter(d_949302066 != 231311385 & qolcomplt!="Not Eligible") # Those who are eligible for PROMIS but didn't complete mod1 yet
#dim(reduced)[[1]] 

Comp_by_race %>% kable_styling(latex_options = c("scale_down","hold_position")) %>% 
  footnote(general = paste0('In order to determine race, Module 1 must first be completed. There are ', dim(reduced)[[1]] , ' QOL eligible participants that have either not started or not finished Module 1.'),general_title = "Note: ", footnote_as_chunk = T)


```


```{r By_Race_And_Sex, echo=FALSE, warning=FALSE, message=FALSE, results='asis'}

promis = promis %>%  mutate(sex_race= case_when(sex=="Female" & multi_racial==1 ~ "Female: Multi-Racial",
                                            sex=="Female" & D_384191091_D_384191091_D_583826374==1 ~ "Female: American Indian or Native American",
                                            sex=="Female" & D_384191091_D_384191091_D_636411467==1 ~ "Female: Asian/Asian American",
                                            sex=="Female" & D_384191091_D_384191091_D_458435048==1 ~ "Female: Black, African American, or African",
                                            sex=="Female" & D_384191091_D_384191091_D_706998638==1 ~ "Female: Hispanic, Latino, or Spanish",
                                            sex=="Female" & D_384191091_D_384191091_D_973565052==1 ~ "Female: Middle Eastern or North African",
                                            sex=="Female" & D_384191091_D_384191091_D_586825330==1 ~ "Female: Hawaiian or Pacific Islander",
                                            sex=="Female" & D_384191091_D_384191091_D_412790539==1 ~ "Female: White",
                                            sex=="Female" & (D_384191091_D_384191091_D_807835037==1 | !is.na(D_384191091_D_747350323)) ~ "Female: Other",
                                            sex=="Female" & D_384191091_D_384191091_D_746038746==1 ~ "Female: Prefer Not to Answer",
                                            
                                            sex=="Male" & multi_racial==1 ~ "Male: Multi-Racial",
                                            sex=="Male" & D_384191091_D_384191091_D_583826374==1 ~ "Male: American Indian or Native American",
                                            sex=="Male" & D_384191091_D_384191091_D_636411467==1 ~ "Male: Asian/Asian American",
                                            sex=="Male" & D_384191091_D_384191091_D_458435048==1 ~ "Male: Black, African American, or African",
                                            sex=="Male" & D_384191091_D_384191091_D_706998638==1 ~ "Male: Hispanic, Latino, or Spanish",
                                            sex=="Male" & D_384191091_D_384191091_D_973565052==1 ~ "Male: Middle Eastern or North African",
                                            sex=="Male" & D_384191091_D_384191091_D_586825330==1 ~ "Male: Hawaiian or Pacific Islander",
                                            sex=="Male" & D_384191091_D_384191091_D_412790539==1 ~ "Male: White",
                                            sex=="Male" & (D_384191091_D_384191091_D_807835037==1 | !is.na(D_384191091_D_747350323)) ~ "Male: Other",
                                            sex=="Male" & D_384191091_D_384191091_D_746038746==1 ~ "Male: Prefer Not to Answer",
                                            
                                            sex=="Unknown" & multi_racial==1 ~ "Unknown: Multi-Racial",
                                            sex=="Unknown" & D_384191091_D_384191091_D_583826374==1 ~ "Unknown: American Indian or Native American",
                                            sex=="Unknown" & D_384191091_D_384191091_D_636411467==1 ~ "Unknown: Asian/Asian American",
                                            sex=="Unknown" & D_384191091_D_384191091_D_458435048==1 ~ "Unknown: Black, African American, or African",
                                            sex=="Unknown" & D_384191091_D_384191091_D_706998638==1 ~ "Unknown: Hispanic, Latino, or Spanish",
                                            sex=="Unknown" & D_384191091_D_384191091_D_973565052==1 ~ "Unknown: Middle Eastern or North African",
                                            sex=="Unknown" & D_384191091_D_384191091_D_586825330==1 ~ "Unknown: Hawaiian or Pacific Islander",
                                            sex=="Unknown" & D_384191091_D_384191091_D_412790539==1 ~ "Unknown: White",
                                            sex=="Unknown" & (D_384191091_D_384191091_D_807835037==1 | !is.na(D_384191091_D_747350323)) ~ "Unknown: Other",
                                            sex=="Unknown" & D_384191091_D_384191091_D_746038746==1 ~ "Unknown: Prefer Not to Answer",
                                                     TRUE  ~ "Skipped this question"))

Comp_by_sex_race <- promis %>% filter(qolcomplt!="Not Eligible") %>% 
  mutate(qolcomplt = factor(qolcomplt, levels=c("Not Started", "Started", "Submitted"))) %>% 
  select(sex_race, qolcomplt) %>% dplyr::arrange(sex_race,qolcomplt) %>% 
  tbl_cross(
  row = sex_race,
  col = qolcomplt,
  label = list(qolcomplt ~ "Survey Completion",sex_race~"Sex and Race"),
  percent = "row",
  digits=c(0,2),
  margin_text="Total QOL Eligible Participants") 

#Comp_by_sex_race[["table_body"]]$stat_0 <- sapply(strsplit(Comp_by_sex_race[["table_body"]]$stat_0," "),"[",1)

Comp_by_sex_race <- Comp_by_sex_race %>%
  #bold_labels() %>%
  #italicize_levels() %>% 
  modify_header(stat_0 = "Total QOL Eligible \n Participants") %>%
  modify_caption("Table 16. 3-Month Quality of Life Survey Completion Rate by Sex and Race \n Among Eligible Participants") %>%
  as_kable_extra(escape = FALSE, addtl_fmt = TRUE)

reduced <- all_data %>% filter(d_949302066 != 231311385 & qolcomplt!="Not Eligible") # Those who are eligible for PROMIS but didn't complete mod1 yet
#dim(reduced)[[1]] 

Comp_by_sex_race %>% kable_styling(latex_options = c("scale_down","hold_position")) %>% 
  footnote(general = paste0('In order to determine race, Module 1 must first be completed. There are ', dim(reduced)[[1]] , ' QOL eligible participants that have either not started or not finished Module 1.'),general_title = "Note: ", footnote_as_chunk = T)


```


```{r By_Demographic, echo=FALSE, warning=FALSE, message=FALSE, results='asis'}

promis <- promis %>%
  mutate(
    "White Women" = if_else(race == "White" & sex == "Female", 1, 0),
    "Black Men" = if_else(race == "Black, African American, or African" & sex == "Male", 1, 0),
    "Women Under 45" = if_else((age == "35-39" | age == "40-45") & sex == "Female", 1, 0),
    "Women Over 45" = if_else((age == "46-50" | age == "51-55" | age == "56-60" | age == "61-65" | age == "66-70") & sex == "Female", 1, 0),
    "Men Under 45" = if_else((age == "35-39" | age == "40-45") & sex == "Male", 1, 0),
    "Men Over 45" = if_else((age == "46-50" | age == "51-55" | age == "56-60" | age == "61-65" | age == "66-70") & sex == "Male", 1, 0)
  )

# Can be in more then one category
all_data_long <- promis %>%
  pivot_longer(cols = c("White Women", "Black Men", "Women Under 45", "Women Over 45", "Men Under 45", "Men Over 45"),
               names_to = "Demographic_Group", values_to = "Flag") %>%
  filter(Flag == 1)  # Keep only rows where participants are in one or more of these demographics


Comp_by_Demographic <- all_data_long %>% 
  filter(qolcomplt != "Not Eligible") %>%
  mutate(qolcomplt = factor(qolcomplt, levels = c("Not Started", "Started", "Submitted")),
         Demographic_Group = factor(Demographic_Group, levels=c("White Women","Black Men","Women Under 45","Women Over 45","Men Under 45","Men Over 45"))) %>%
  select(Demographic_Group, qolcomplt) %>%
  #arrange(Demographic_Group, qolcomplt) %>%
  tbl_cross(
    row = Demographic_Group,
    col = qolcomplt,
    label = list(qolcomplt ~ "Survey Completion", Demographic_Group ~ "Demographic"),
    percent = "row",
    digits = c(0, 2),
    margin_text = "Total"
  )


Comp_by_Demographic <- Comp_by_Demographic %>%
  modify_header(stat_0 = "Total") %>%
  modify_caption("Tbale 17. 3-Month Quality of Life Survey Completion Rate \n by Demographic Among Eligible Participants") %>%
  as_kable_extra(escape = FALSE, addtl_fmt = TRUE)

# Style the table output
Comp_by_Demographic %>% kable_styling(latex_options = c("scale_down", "hold_position"))  %>% 
  footnote(general = "Participants may be counted more then once in these categories.",general_title = "Note: ", footnote_as_chunk = T)


```

\FloatBarrier
```{r QOL_start_stop, echo=FALSE, warning=FALSE, message=FALSE}




QOL_time <- all_data %>% 
  mutate(compTM_qol = as.numeric(difftime(as.POSIXct(ymd_hms(d_843688458)), as.POSIXct(ymd_hms(d_870643066)), units="mins")),
         permission = case_when(compTM_qol<5 ~ "Under 5 Minutes",
                                compTM_qol<10 ~ "5-10 Minutes",
                                compTM_qol<15 ~ "10-15 Minutes",
                                compTM_qol<20 ~ "15-20 Minutes",
                                compTM_qol<30 ~ "20-30 Minutes",
                                compTM_qol>=30 ~ "30+ Minutes"),
         permission = factor(permission, levels=c("Under 5 Minutes", "5-10 Minutes", "10-15 Minutes", 
                                                   "15-20 Minutes", "20-30 Minutes", "30+ Minutes")))  %>% 
    group_by(permission) %>% tally()

QOL_time$Percentage <- (QOL_time$n / sum(QOL_time$n)) * 100
QOL_time <- QOL_time[c(1:6),]

summary_row <- data.frame(permission = "Total QOL Eligible Participants",
                          n = sum(QOL_time$n),
                          Percentage = 100)


QOL_TM <- rbind(QOL_time, summary_row)

QOL_TM[1, 4] <- paste0(formatC(QOL_TM[1, 2], big.mark = ",", format = "d"), " (", round(QOL_TM[1, 3], digits = 1), "%)")
QOL_TM[2, 4] <- paste0(formatC(QOL_TM[2, 2], big.mark = ",", format = "d"), " (", round(QOL_TM[2, 3], digits = 1), "%)")
QOL_TM[3, 4] <- paste0(formatC(QOL_TM[3, 2], big.mark = ",", format = "d"), " (", round(QOL_TM[3, 3], digits = 1), "%)")
QOL_TM[4, 4] <- paste0(formatC(QOL_TM[4, 2], big.mark = ",", format = "d"), " (", round(QOL_TM[4, 3], digits = 1), "%)")
QOL_TM[5, 4] <- paste0(formatC(QOL_TM[5, 2], big.mark = ",", format = "d"), " (", round(QOL_TM[5, 3], digits = 1), "%)")
QOL_TM[6, 4] <- paste0(formatC(QOL_TM[6, 2], big.mark = ",", format = "d"), " (", round(QOL_TM[6, 3], digits = 1), "%)")
QOL_TM[7, 4] <- paste0(formatC(QOL_TM[7, 2], big.mark = ",", format = "d"), " (", round(QOL_TM[7, 3], digits = 1), "%)")


QOL_TM_table <- QOL_TM[, c(1,4)]

colnames(QOL_TM_table) <- c("Completion Time", "N%")

knitr::kable(QOL_TM_table, #format.args = list(big.mark = ","),
             caption = 'Table 18. 3-Month Quality of Life Survey Completion Time from Start to Submit \n Among Eligible Participants', 
             booktabs=T, linesep = "", row.names=FALSE, align=c("l", "c")) %>% 
  add_indent(c(1:(nrow(QOL_TM_table)-1))) %>%  
  kable_styling(latex_options = "scale_down") #c("scale_down","hold_position"))

```


```{r Table14, echo=FALSE, warning=FALSE, message=FALSE}




## Time from QOL trigger to submission of QOL survey
# category= 3mo QOL Survey Reminders attempt=1st contact notification_time will be used in place of FIRST_QOL_REMINDER

trig_qol <- bq_project_query(project,
query="SELECT distinct(token), notification_time FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.notifications_JP`
where category='3mo QOL Survey Reminders' and attempt='1st contact'")
trigger <- bigrquery::bq_table_download(trig_qol,bigint = "integer64")


trigger_time <- left_join(all_data, trigger, by="token")


## Those verified after 12/1/2024 were notified
trigger_time$trig <- ifelse(as.Date(trigger_time$d_914594314)> "2024-12-01", trigger_time$notification_time,
                            as.Date(as.Date(trigger_time$d_914594314) + 90))

trig_time<- trigger_time %>%  filter(d_320303124 == 231311385) %>%
  mutate(trigTM_qol = as.numeric(difftime(as.POSIXct(ymd_hms(d_843688458)), as.POSIXct(ymd_hms(notification_time)), units="days")))

Trig_table = trig_time %>%
  dplyr::summarize('N'=n(),
                   Min = round(min(trigTM_qol, na.rm = TRUE), digits=2),
                   Q1 = round(quantile(trigTM_qol, 0.25, na.rm = TRUE), digits=2),
                   Median = round(median(trigTM_qol, na.rm = TRUE), digits=2),
                   Mean = round(mean(trigTM_qol, na.rm = TRUE),  digits=2),
                   SD= round(sd(trigTM_qol, na.rm = TRUE), digits=2),
                   Q3 = round(quantile(trigTM_qol, 0.75, na.rm = TRUE), digits=2),
                   'Perc.90' = round(quantile(trigTM_qol, 0.90, na.rm = TRUE), digits=2),
                   Max = round(max(trigTM_qol, na.rm = TRUE), digits=2))

knitr::kable(Trig_table, 
             caption = 'Table 14. 3-Month Quality of Life Survey Completion from Trigger to Submit for \n Verified Participants, in Days', 
             row.names=FALSE, format.args = list(big.mark = ","), linesep = "", 
             booktabs = T, align=c("l", "c", "c", "c", "c", "c", "c", "c", "c")) %>% 
  kable_styling(latex_options = c("scale_down","hold_position")) 

```


                   
\FloatBarrier

```{r QOL_trig, echo=FALSE, warning=FALSE, message=FALSE}

knitr::kable(Trig_table, 
             caption = 'Table 19. 3-Month Quality of Life Survey Completion from Trigger to Submit for \n Verified Participants, in Days', 
             row.names=FALSE, format.args = list(big.mark = ","), linesep = "", 
             booktabs = T, align=c("l", "c", "c", "c", "c", "c", "c", "c", "c")) %>% 
  kable_styling(latex_options = c("scale_down","hold_position")) 

```


                   
\FloatBarrier

```{r Pref_Lang_Time_All, echo=FALSE, warning=FALSE, message=FALSE}


all_data %>% tbl_cross(
    col = Pref_lang,
    row = Site,
    digits=c(0,1),
    percent = "column",
    label=list(Pref_lang="Preferred Language",
                Site = "Site"),
    missing="ifany",
    margin_text="Total") %>% 
  modify_header(stat_0 = "Total") %>%
  modify_caption("Table 20. Preferred Language by Site") %>%
  as_kable_extra(escape = FALSE, addtl_fmt = TRUE) %>%  
  kable_styling(latex_options = "scale_down") 

```






```{r Survey_Flag_Setup, echo=FALSE, warning = FALSE, include=FALSE}


## SSN survey is not viewable in BQ so we will not have the language flag for that survey



queries <- list(
  m1_lang_c = "SELECT pts.Connect_ID, m1.d_784119588, d_255077064
                FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.module1_v2_JP` m1
                left join `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP` pts
                on m1.Connect_ID=pts.Connect_ID
                WHERE pts.Connect_ID IS NOT NULL and d_949302066='231311385'",
  m2_lang_c = "SELECT pts.Connect_ID, m2.d_784119588, d_255077064 
                FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.module2_v2_JP` m2
                left join `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP` pts
                on m2.Connect_ID=pts.Connect_ID
                WHERE pts.Connect_ID IS NOT NULL and d_536735468='231311385'",
  m3_lang_c = "SELECT pts.Connect_ID, m3.d_784119588, d_255077064 
                FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.module3_v1_JP` m3
                left join `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP` pts
                on m3.Connect_ID=pts.Connect_ID
                WHERE pts.Connect_ID IS NOT NULL and d_976570371='231311385'",
  m4_lang_c = "SELECT pts.Connect_ID, m4.d_784119588, d_255077064 
                FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.module4_v1_JP` m4
                left join `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP` pts
                on m4.Connect_ID=pts.Connect_ID
                WHERE pts.Connect_ID IS NOT NULL and pts.d_663265240='231311385'",
  BUM_lang_c = "SELECT pts.Connect_ID, bum.d_784119588, d_255077064 
                FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.bioSurvey_v1_JP` bum
                left join `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP` pts
                on bum.Connect_ID=pts.Connect_ID
                WHERE pts.Connect_ID IS NOT NULL and d_265193023='231311385'",
  BU_lang_c = "SELECT pts.Connect_ID, bu.d_784119588, d_255077064
                FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.clinicalBioSurvey_v1_JP` bu 
                left join `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP` pts
                on bu.Connect_ID=pts.Connect_ID
                WHERE pts.Connect_ID IS NOT NULL and d_253883960='231311385'",
  CV_lang_c = "SELECT pts.Connect_ID, cv.d_784119588, d_255077064 
                FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.covid19Survey_v1_JP` cv
                left join `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP` pts
                on cv.Connect_ID=pts.Connect_ID
                WHERE pts.Connect_ID IS NOT NULL and d_220186468='231311385'",
  Mens_lang_c = "SELECT pts.Connect_ID, mns.d_784119588, d_255077064 
                FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.menstrualSurvey_v1_JP` mns
                left join `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP` pts
                on mns.Connect_ID=pts.Connect_ID
                WHERE pts.Connect_ID IS NOT NULL and d_459098666='231311385'",
  MW_lang_c = "SELECT pts.Connect_ID, mw.d_784119588, d_255077064 
                FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.mouthwash_v1_JP` mw
                left join `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP` pts
                on mw.Connect_ID=pts.Connect_ID
                WHERE pts.Connect_ID IS NOT NULL and d_547363263='231311385'",
  QOL_lang_c = "SELECT pts.Connect_ID, qol.d_784119588, d_255077064
                FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.promis_v1_JP` qol
                left join `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP` pts
                on qol.Connect_ID=pts.Connect_ID
                WHERE pts.Connect_ID IS NOT NULL and d_320303124='231311385'"
)


results_list <- list()


for (name in names(queries)) {
  query <- queries[[name]]
  query_result <- bq_project_query(project, query)
  data <- bq_table_download(query_result, bigint = "integer64")
  results_list[[name]] <- data
}


m1_lang <- results_list$m1_lang_c
m2_lang <- results_list$m2_lang_c
m3_lang <- results_list$m3_lang_c
m4_lang <- results_list$m4_lang_c
BUM_lang <- results_list$BUM_lang_c
BU_lang <- results_list$BU_lang_c
CV_lang <- results_list$CV_lang_c
Mens_lang <- results_list$Mens_lang_c
MW_lang <- results_list$MW_lang_c
QOL_lang <- results_list$QOL_lang_c




```


\FloatBarrier
```{r Svy_Lang_Diff, echo=FALSE, warning=FALSE, message=FALSE, results='asis'}


# Define the list of survey data frames
survey_dfs <- list(m1_lang, m2_lang, m3_lang, m4_lang, BUM_lang, BU_lang, CV_lang, Mens_lang, MW_lang, QOL_lang)

# Initialize an empty data frame to store results for all participants
all_scenarios <- data.frame(Connect_ID = character(), Flag = character(), Pref_lang = character(), stringsAsFactors = FALSE)

# Loop through each survey data frame
for (current_df in survey_dfs) {
  current_df <- current_df %>%
    mutate(
      Flag = ifelse(is.na(d_784119588), NA, ifelse(d_784119588 == 773342525, "Spanish", "English")),
      Pref_lang = case_when(d_255077064 == 773342525 ~ "Spanish", TRUE ~ "English")
    )
  
  # Extract relevant columns and add to the scenario tracking data frame
  participant_scenarios <- current_df %>%
    select(Connect_ID, Flag, Pref_lang)
  
  all_scenarios <- bind_rows(all_scenarios, participant_scenarios)
}

# Summarize the scenario for each participant
final_scenarios <- all_scenarios %>%
  group_by(Connect_ID) %>%
  summarize(
    Flag_set = unique(na.omit(Flag)), # Remove NAs from Flags
    Pref_lang_set = unique(Pref_lang),
    scenario = case_when(
      length(Flag_set) == 0 ~ "No survey language preference has been made", # No Flag values
      all(Flag_set == Pref_lang_set) ~ "Survey Flags and Preferred Language Consistent", # All Flags match Pref_lang
      any(Flag_set != Pref_lang_set) ~ "Any Survey Flag Inconsistent with Preferred Language" # Any inconsistency
    )
  ) %>%
  ungroup()

# Summarize the counts for each scenario
scenario_counts <- final_scenarios %>%
  count(scenario) %>%
  dplyr::rename(Scenario = scenario, 'Total Participants' = n)

consist <- knitr::kable(scenario_counts,
                        caption = "Table 21. Consistency of Language Choice in Survey Completion",
                        row.names = FALSE, align = c("l", "c"), digits = 2, booktabs = TRUE) %>%
  kable_styling(latex_options = "scale_down") # c("scale_down","hold_position")) 

add_footnote(consist, "Note: Those who do not start any surveys will not have survey flags, and thus not be counted in this table. Those that start but do not complete a survey will still choose a survey language.", notation = "none")



# 
# # Initialize a data frame to store the counts for each scenario
# scenario_counts <- data.frame(
#   Scenario = c(
#     "Survey Flags and Preferred Language Consistent",
#     "Any Survey Flag Inconsistent with Preferred Language"
#   ),
#   Count = 0
# )
# 
# # Loop through each survey data frame
# for (current_df in survey_dfs) {
#   # Apply the necessary mutations
#   current_df <- current_df %>%
#     mutate(
#       Flag = case_when(d_784119588 == 773342525 ~ "Spanish", TRUE ~ "English"),
#       Pref_lang = case_when(d_255077064 == 773342525 ~ "Spanish", TRUE ~ "English")
#     )
#   
#   
#   scenario_counts$Count[1] <- scenario_counts$Count[1] + nrow(current_df %>% filter((Flag == "Spanish" & Pref_lang == "Spanish")| Flag == "English" & Pref_lang == "English"))
#   scenario_counts$Count[2] <- scenario_counts$Count[2] + nrow(current_df %>% filter((Flag == "English" & Pref_lang == "Spanish")| Flag == "Spanish" & Pref_lang == "English"))
# }
# 
# 
#  knitr::kable(scenario_counts,
#                caption = "Table 12. Consistency of Language Choice in Survey Completion",
#                row.names = FALSE, align = c("l","c","c","c","c","c","c","c"), digits = 2, booktabs = TRUE) %>%
#     kable_styling(latex_options = c("scale_down","hold_position"))

```

\newpage                        
\FloatBarrier
```{r Svy_Lang_Compare, echo=FALSE, warning=FALSE, message=FALSE, results='asis'}


survey_acronyms <- c("BOH", "MRE", "SAS", "LAW", "BUM", "BU", "COVID", "MENS", "MW", "QOL")


create_table <- function(current_df, current_acronym) {
  if (nrow(current_df) == 0) {
    return(data.frame(Survey = current_acronym, English = 0, Spanish = 0, Total = 0))
  }
  
  all_svry_flags <- current_df %>%
    mutate(Survey = case_when(!is.na(Connect_ID) ~ current_acronym,
                              TRUE ~ "NA"),
           Flag = case_when(d_784119588 == 773342525 ~ "Spanish",
                            TRUE ~ "English")) %>%
    tbl_cross(
      col =Flag,
      row = Survey,
      digits = c(0, 1),
      percent = "row",
      label = list(Flag = "Survey Flag",
                   Site = "Survey"),
      missing = "ifany",
      margin_text = "Total") %>%
    modify_header(stat_0 = "Total")
  
  df_all_svry_flags <- as.data.frame(all_svry_flags)
  colnames(df_all_svry_flags)[1] <- "Survey"
  df_all_svry_flags <- df_all_svry_flags[2,]
  
  # Ensure the data frame has consistent columns by adding missing ones with zeros
  expected_columns <- c("Survey", "English", "Spanish", "Total")
  missing_columns <- setdiff(expected_columns, names(df_all_svry_flags))
  
  if (length(missing_columns) > 0) {
    for (col in missing_columns) {
      df_all_svry_flags[[col]] <- 0
    }
  }
  
  df_all_svry_flags <- df_all_svry_flags[expected_columns]
  
  return(df_all_svry_flags)
}

# Initialize empty lists to store the results for each condition
all_flags_list_overall <- list()
all_flags_list_condition1 <- list()
all_flags_list_condition2 <- list()

# Loop through each survey data frame and acronym
for (i in seq_along(survey_dfs)) {
  # Get the current data frame and acronym
  current_df <- survey_dfs[[i]]
  current_acronym <- survey_acronyms[i]
  
  # Overall table
  df_overall <- create_table(current_df, current_acronym)
  all_flags_list_overall[[current_acronym]] <- df_overall
  
  # Spanish
  current_df_cond1 <- current_df %>% filter(d_255077064 == 773342525)
  df_condition1 <- create_table(current_df_cond1, current_acronym)
  all_flags_list_condition1[[current_acronym]] <- df_condition1
  
  # English
  current_df_cond2 <- current_df %>% filter(d_255077064 == 163149180 | is.na(d_255077064))
  df_condition2 <- create_table(current_df_cond2, current_acronym)
  all_flags_list_condition2[[current_acronym]] <- df_condition2
}


final_df_overall <- do.call(rbind, all_flags_list_overall)
final_df_condition1 <- do.call(rbind, all_flags_list_condition1)
final_df_condition2 <- do.call(rbind, all_flags_list_condition2)



knitr::kable(final_df_overall,
               caption = paste0("Table 22. Survey Completion by Survey Language \n Among All Participants"),
               row.names = FALSE, align = c("l","c","c","c"), digits = 2, booktabs = TRUE) %>% 
  add_indent(1:10) %>%  
  kable_styling(latex_options = "scale_down")

knitr::kable(final_df_condition1,
               caption = paste0("Table 22.a. Survey Completion by Survey Language \n Among Participants with Preferred language of Spanish"),
               row.names = FALSE, align = c("l","c","c","c"), digits = 2, booktabs = TRUE) %>% 
  add_indent(1:10) %>%  
  kable_styling(latex_options = "scale_down")

knitr::kable(final_df_condition2,
               caption = paste0("Table 22.b. Survey Completion by Survey Language \n Among Participants with Preferred language of English"),
               row.names = FALSE, align = c("l","c","c","c"), digits = 2, booktabs = TRUE) %>% 
  add_indent(1:10) %>%  
  kable_styling(latex_options = "scale_down")


```


\newpage

\FloatBarrier
```{r BL_start_stop_Lang, echo=FALSE, warning=FALSE, message=FALSE, results='asis'}

summarize_data <- function(data, filter_column, filter_value, language_value, target_column) {
    data %>% 
        filter(!!sym(filter_column) == filter_value & Pref_lang == language_value) %>% 
        summarize('N' = n(),
                  Min = min(!!sym(target_column), na.rm = TRUE),
                  Q1 = quantile(!!sym(target_column), 0.25, na.rm = TRUE),
                  Median = median(!!sym(target_column), na.rm = TRUE),
                  Mean = mean(!!sym(target_column), na.rm = TRUE), 
                  SD = sd(!!sym(target_column), na.rm = TRUE),
                  Q3 = quantile(!!sym(target_column), 0.75, na.rm = TRUE),
                  'Perc.90' = quantile(!!sym(target_column), 0.90, na.rm = TRUE),
                  Max = max(!!sym(target_column), na.rm = TRUE))
}

BOH_LangE <- summarize_data(all_data, "d_949302066", 231311385, "English", "m1_comp_mins")
MRE_LangE <- summarize_data(all_data, "d_536735468", 231311385, "English", "m2_comp_mins")
SAS_LangE <- summarize_data(all_data, "d_976570371", 231311385, "English", "m3_comp_mins")
LAW_LangE <- summarize_data(all_data, "d_663265240", 231311385, "English", "m4_comp_mins")

BOH_LangSP <- summarize_data(all_data, "d_949302066", 231311385, "Spanish", "m1_comp_mins")
MRE_LangSP <- summarize_data(all_data, "d_536735468", 231311385, "Spanish", "m2_comp_mins")
SAS_LangSP <- summarize_data(all_data, "d_976570371", 231311385, "Spanish", "m3_comp_mins")
LAW_LangSP <- summarize_data(all_data, "d_663265240", 231311385, "Spanish", "m4_comp_mins")



BL_lang_E <- rbind(BOH_LangE, MRE_LangE, SAS_LangE, LAW_LangE)
BL_lang_SP <- rbind(BOH_LangSP, MRE_LangSP, SAS_LangSP, LAW_LangSP)


BL_lang_E[,10] <- c("BOH", "MRE", "SAS", "LAW")
BL_lang_SP[,10] <- c("BOH", "MRE", "SAS", "LAW")

BL_lang_E<- BL_lang_E[, c(10,1:9)]
BL_lang_SP<- BL_lang_SP[, c(10,1:9)]


colnames(BL_lang_E)[1] <- "Section"
colnames(BL_lang_SP)[1] <- "Section"

knitr::kable(BL_lang_E, format.args = list(big.mark = ","), digits=2, 
             caption='23.a. Time (in minutes) from Start to Submit of Initial Survey Modules for English',
             row.names=FALSE, align=c("l","c","c","c","c","c","c","c","c"), booktabs = TRUE)%>% 
    kable_styling(latex_options = c("scale_down","hold_position")) 

knitr::kable(BL_lang_SP, format.args = list(big.mark = ","), digits=2, 
             caption='Table 23.b. Time (in minutes) from Start to Submit of Initial Survey Modules for Spanish',
             row.names=FALSE, align=c("l","c","c","c","c","c","c","c","c"),booktabs = TRUE)%>% 
    kable_styling(latex_options = c("scale_down","hold_position")) 

```

