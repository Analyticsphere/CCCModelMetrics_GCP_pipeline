
---
title: "Weekly CCC Metrics for Sections BOH, LAW, MRE, and SAS"
author: "Kelsey Sanchez"
date: 'Data Extracted and Report Ran: `r Sys.Date()`'
output:
  pdf_document:
    extra_dependencies: float
    toc: no
    keep_tex: yes
    fig_width: 7
    fig_height: 5
    fig_caption: yes
    df_print: paged
header-includes: \usepackage[labelformat=empty]{caption} \usepackage{placeins} \usepackage{booktabs}
  \usepackage{pdflscape}
---






```{r libraries, include=FALSE, warning=FALSE}

 # \usepackage{caption}
 # \captionsetup[figure]{labelformat=empty}


#old.packages()
#update.packages("tinytex")


library(bigrquery)
library(dplyr)
library(gmodels)
library(epiDisplay)
library(lubridate)
library(tidyverse)
library(knitr)
#install_tinytex()
#library(tinytex)
#library(vtable)
library(kableExtra)
library(gtsummary)


bq_auth()


# ```{r setup, include=FALSE}
# options(width = 80)
# options(tinytex.verbose = TRUE) --- didn't work
# ```

```


```{r, echo=FALSE}

# cat("In order of how the sections appear on MyConnect, the Initial Survey Sections are: \n 
# BOH= Background and Overall Health (Module 1)  \n
# LAW= Where you Live and Work (Module 4)\n
# MRE= Medications, Reproductive Health, Exercise, and Sleep (Module 2)\n
# SAS= Smoking, Alcohol, and Sun Exposure (Module 3)")

# Example vector with # symbol
#my_vector <- c("In order of how the sections appear on MyConnect, the Initial Survey Sections are:", "BOH= Background and Overall Health (Module 1)", "LAW= Where you Live and Work (Module 4)","MRE= Medications, Reproductive Health, Exercise, and Sleep (Module 2)" , "SAS= Smoking, Alcohol, and Sun Exposure (Module 3)")

# Printing vector without "#" symbol
#cat(my_vector, sep = "\n", "\n", comment = "")

#paste(my_vector, collapse = '\n') %>% cat()

```

In order of how the sections appear on MyConnect, the Initial Survey Sections are:  

BOH= Background and Overall Health (Module 1)  

LAW= Where you Live and Work (Module 4)

MRE= Medications, Reproductive Health, Exercise, and Sleep (Module 2)

SAS= Smoking, Alcohol, and Sun Exposure (Module 3)


```{r querystatus, include=FALSE}

# ##Make sure SQL queries are properly running
# 
# 
# check_sch_query_status <- 
#   function(project, table_name){
# 
#     ## Set default project for BQ CLI
#     #set_proj_cmd <- paste0("bq ls -j --project_id ", project, " > /dev/null")
#     #system(set_proj_cmd)
#     
#     # Get list of scheduled queries from bq
#     bq_request <- 'bq ls --transfer_config --transfer_location="us" --filter="dataSourceIds:scheduled_query"'
#     response   <- system(bq_request, intern=TRUE)
#     # Remove second line "----" of table and remove white space from each row
#     response   <- lapply(response[-2], function(x) scan(text = x, what = ""))
#     header     <- simplify2array(response[1]) # Array of column names
#     
#     # Bind rows of data into one array
#     for (i in length(header)){
#       x <- c() # Initialize array with first non-header line of data
#       # Loop through remaining data
#       for (line in response[2:length(response)]){
#         x <- rbind(x, line)
#       }
#     }
#     
#     # Format as dataframe
#     df <- data.frame(x, row.names = NULL)
#     colnames(df) <- header
#     
#     # Return sch. query status as "SUCCEEDED", "PENDING", "RUNNING" or "FAILED".
#     df$state[df$displayName==table_name] 
#   }
# 
# 
# table_name <- "FlatConnect.participants_JP"
# project    <- "nih-nci-dceg-connect-prod-6d04"
# 
# # Check status of scheduled query
# query_status <- check_sch_query_status(project, table_name)
# switch(query_status,
#  "FAILED"    = stop(paste0("The sch. query for ", table_name, " failed. Reach out to Jake.")),
#   "PENDING"   = stop(paste0("The query for ", table_name, " is scheduled and waiting to be run.")),
#   "RUNNING"   = stop(paste0("The sch. query for ", table_name, " is still running. Wait until complete.")),
#   "SUCCEEDED" = print(paste0("The most recent scheduled query for ", table_name, " succeeded. The table is up-to-date."))
# )
# 
# 
# table_name <- "FlatConnect.bioSurvey_v1_JP"
# project    <- "nih-nci-dceg-connect-prod-6d04"
# 
# # Check status of scheduled query
# query_status <- check_sch_query_status(project, table_name)
# switch(query_status,
#  "FAILED"    = stop(paste0("The sch. query for ", table_name, " failed. Reach out to Jake.")),
#   "PENDING"   = stop(paste0("The query for ", table_name, " is scheduled and waiting to be run.")),
#   "RUNNING"   = stop(paste0("The sch. query for ", table_name, " is still running. Wait until complete.")),
#   "SUCCEEDED" = print(paste0("The most recent scheduled query for ", table_name, " succeeded. The table is up-to-date."))
# )


```


```{r BQPull, include=FALSE}
## CCC WEEKLY METRICS REPORT 



### To run the code, note questions 1,5,6,7, and 8 apply to all modules and questions 2-4 apply individually to each module. Run #1 first, then #2-4 for reach module, then #6-8



##Load Data from BQ

project_cc = "nih-nci-dceg-connect-prod-6d04"
queryreccc <- "SELECT  Connect_ID, d_512820379, d_821247024, d_914594314, d_832139544, d_949302066 , d_205553981, d_536735468 , d_976570371, d_663265240, d_265193023, d_222161762,d_770257102, d_264644252, d_265193023, d_541836531, d_386488297, d_452942800, d_517311251 , d_822499427, d_126331570, d_914639140, d_311580100, d_827220437, d_100767870, d_831041022 FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP` where Connect_ID IS NOT NULL  and (d_512820379='486306141' OR d_512820379='854703046') " 

#and d_831041022='104430631'-- not needed, according to 3/12/24 decisions we'll be keeping participant journeys in overall counts

rec_table_cc <- bq_project_query(project_cc, queryreccc)
data_c <- bq_table_download(rec_table_cc, bigint = "integer64")


data_ccc <- data_c %>%  filter(d_821247024==197316935) #need this separate filter to look at participants unable to be verified



data_ccc <- data_ccc %>% mutate(Recruit_Type= case_when(d_512820379==486306141 ~ "Active",
                                                  d_512820379==854703046 ~ "Passive"))


knitr::opts_chunk$set(comment = NA)


data_tib= as_tibble(data_ccc) 


modules <- data_tib[,c("Connect_ID","d_512820379","d_949302066","d_536735468","d_976570371","d_663265240", "d_914594314")] 
mods <- c("d_949302066","d_536735468","d_976570371","d_663265240")
modules$modules <- 0
modules$none <-0
for(i in 1:length(mods)){
  module <- modules[,mods[i]]
  count <- ifelse((!is.na(module) & module ==231311385), 1, 0)
  modules$modules <- count+modules$modules
  count1 <- ifelse((!is.na(module) & module==972455046), 1, 0)
  modules$none <- count1+modules$none
}

#table(modules$modules)

#table(modules$none)

#table(modules$modules,modules$d_949302066)
#CrossTable(modules$d_949302066, modules$modules,digits=4, prop.t=FALSE, prop.r=TRUE, prop.c=TRUE,prop.chisq=FALSE)

length(modules[which(modules$modules==3 & modules$d_663265240==231311385 & modules$d_536735468==231311385),])

modules1 <- modules %>% mutate(process = case_when(as.character(modules) =='0' ~ "None",
                                                   d_949302066 == '231311385' & as.character(modules) == '1' ~ "BOH Section only",
                                                   as.character(modules) == '2' & d_949302066 == '231311385' & d_536735468 == '231311385' ~ "BOH and MRE Sections" ,
                                                   as.character(modules) =='2' & d_949302066 == '231311385' & d_976570371 == '231311385' ~ "BOH and SAS Sections" , 
                                                   as.character(modules) =='2' & d_949302066 == '231311385' & d_663265240 == '231311385' ~ "BOH and LAW Sections" ,  
                                                   as.character(modules) =='3' & d_949302066 == '231311385' & d_536735468 == '231311385' & d_976570371 == '231311385' ~ "BOH, MRE, and SAS Sections" ,  
                                                   as.character(modules) =='3' & d_949302066 == '231311385' & d_976570371 == '231311385' & d_663265240 == '231311385'~ "BOH, SAS, and LAW Sections" , 
                                                   as.character(modules) =='3' & d_949302066 == '231311385' & d_536735468 == '231311385' & d_663265240 == '231311385' ~ "BOH, MRE, and LAW Sections",   
                                                   as.character(modules) =='4' ~ "All")) 
#style$descr <- factor(style$descr,levels=c("None", "BOH Section only", "BOH and MRE Sections", "BOH and SAS Sections", "BOH and LAW Sections", "BOH, MRE, and SAS Sections", "BOH, SAS, and LAW Sections", "BOH, MRE, and LAW Sections", "All"))


#table(modules1$process)
tab1(modules1$process, decimal=2,sort.group = "decreasing", cum.percent = TRUE)$output.table


#completion <- modules1 %>% select(Connect_ID, process) #have no idea why this isn't working
completion <- modules1[, c(1,10)]
all_data <- left_join(data_tib, completion, by="Connect_ID")

all_data <- all_data %>%  mutate(Site = case_when(d_827220437==125001209 ~ "KP Colorado",
                                                  d_827220437==327912200 ~ "KP Georgia",
                                                  d_827220437==300267574 ~ "KP Hawaii",
                                                  d_827220437==452412599 ~ "KP Northwest",
                                                  d_827220437==548392715 ~ "Henry Ford",
                                                  d_827220437==531629870 ~ "HealthPartners",
                                                  d_827220437==303349821 ~ "Marshfield",
                                                  d_827220437==657167265 ~ "Sanford",
                                                  d_827220437==809703864 ~ "UChicago"),
                                 BSL_compl = case_when(d_100767870==353358909 ~ "All Baseline Modules Completed",
                                                       TRUE ~ "One or More Baseline Modules Not Completed"))

```

 \newpage

```{r newTable1, echo=FALSE, warning=FALSE, message=FALSE}


comp_by_site <- all_data  %>% select(Site, BSL_compl) %>% 
  tbl_cross(  col = BSL_compl,
                  row = Site, 
                   percent = "row",
                   digits= c(0,1),
                   label= c(Site~ "Site", BSL_compl ~ " "),
                   missing="ifany",
                   missing_text="0 ( 0 %)") 

comp_by_site_totals <- as.data.frame(comp_by_site)
comp_by_site_totals <- comp_by_site_totals[-1, ]
comp_by_site_totals <- comp_by_site_totals[c(9,5, 2:4,6:8, 1,10), ]

knitr::kable(comp_by_site_totals , caption='Table 1.Completion of Initial Surveys by Site', row.names=FALSE,align=c("l","c","c","c"), booktabs = TRUE) %>%  add_indent(c(1:9))  %>% kable_styling(latex_options = "scale_down")

```


 
 \newpage
 
```{r Table2, echo=FALSE, warning=FALSE, message=FALSE}
#Make the automated table

all_srvy_comp <- all_data  %>% select(process, Recruit_Type) %>% 
  tbl_cross(  col = Recruit_Type,
                  row = process, 
                   percent = "col",
                   digits= c(0,1),
                   label= c(process~ "Sections Submitted", Recruit_Type ~ " "),
                   missing="ifany",
                   missing_text="0 ( 0 %)") 

all_srvy_comp_totals <- as.data.frame(all_srvy_comp)
all_srvy_comp_totals <- all_srvy_comp_totals[-1, ]
all_srvy_comp_totals <- all_srvy_comp_totals[c(9,5, 2:4,6:8, 1,10), ]

overall_surveys <- knitr::kable(all_srvy_comp_totals ,col.names=c("Sections Submitted", "Active Verified","Passive Verified", "Total Verified"), caption='Table 2. Initial Survey Submission Among Verified Participants \n Stratified by Active and Passive Recruits', row.names=FALSE,align=c("l","c","c","c"), booktabs = TRUE) %>%  add_indent(c(1:9))  %>% kable_styling(latex_options = "scale_down")

add_footnote(overall_surveys, "Note: All sections were in MyConnect on July 5,2022. There were 766 verified participants beore that date.", notation = "none")

```


```{r Table3, echo=FALSE, warning=FALSE, message=FALSE}

testing2df <- data.frame(Sections=character(),
                 'Not Started'=integer(),
                 Started=integer(),
                 Submitted=integer(),
                 Total=integer())

#testing2df[1, ] <- c("Section", "Not Started", "Started", "Submitted")
testing2df[1, ] <- c("BOH", paste0(sum(all_data$d_949302066==972455046), " (", round(100*sum(all_data$d_949302066==972455046)/dim(all_data)[[1]], digits = 1), "%)"),
                     paste0(sum(all_data$d_949302066==615768760), " (", round(100*sum(all_data$d_949302066==615768760)/dim(all_data)[[1]], digits = 1), "%)"),
                     paste0(sum(all_data$d_949302066==231311385), " (", round(100*sum(all_data$d_949302066==231311385)/dim(all_data)[[1]], digits = 1), "%)"), 
                     paste(dim(all_data)[[1]], "(100%)"))
testing2df[2, ] <- c("MRE", paste0(sum(all_data$d_536735468==972455046), " (", round(100*sum(all_data$d_536735468==972455046)/dim(all_data)[[1]], digits = 1), "%)"),
                     paste0(sum(all_data$d_536735468==615768760), " (", round(100*sum(all_data$d_536735468==615768760)/dim(all_data)[[1]], digits = 1), "%)"),
                     paste0(sum(all_data$d_536735468==231311385), " (", round(100*sum(all_data$d_536735468==231311385)/dim(all_data)[[1]], digits = 1), "%)"), 
                     paste(dim(all_data)[[1]], "(100%)"))
testing2df[3, ] <- c("SAS", paste0(sum(all_data$d_976570371==972455046), " (", round(100*sum(all_data$d_976570371==972455046)/dim(all_data)[[1]], digits = 1), "%)"),
                     paste0(sum(all_data$d_976570371==615768760), " (", round(100*sum(all_data$d_976570371==615768760)/dim(all_data)[[1]], digits = 1), "%)"),
                     paste0(sum(all_data$d_976570371==231311385), " (", round(100*sum(all_data$d_976570371==231311385)/dim(all_data)[[1]], digits = 1), "%)"), 
                     paste(dim(all_data)[[1]], "(100%)"))
testing2df[4, ] <- c("LAW", paste0(sum(all_data$d_663265240==972455046), " (", round(100*sum(all_data$d_663265240==972455046)/dim(all_data)[[1]], digits = 1), "%)"),
                     paste0(sum(all_data$d_663265240==615768760), " (", round(100*sum(all_data$d_663265240==615768760)/dim(all_data)[[1]], digits = 1), "%)"),
                     paste0(sum(all_data$d_663265240==231311385), " (", round(100*sum(all_data$d_663265240==231311385)/dim(all_data)[[1]], digits = 1), "%)"), 
                     paste(dim(all_data)[[1]], "(100%)"))



knitr::kable(testing2df, caption='Table 3: Initial Survey Section Submission Status Among Verified Participants', col.names=c("Section", "Not Started", "Started", "Submitted", "Total Verified Participants"), row.names=FALSE, align=c("l","c","c","c","c"),digits=1, booktabs = TRUE)%>% kable_styling(latex_options = "hold_position")


```






\newpage
\FloatBarrier


```{r Table4.1, echo=FALSE, error=FALSE, message=FALSE, warning=FALSE, results='asis'}

format_with_decimal <- function(x, digits = 1) {
  formatted_number <- sprintf("%0.1f", x)
  return(formatted_number)
}

all_data <- all_data %>% group_by(Connect_ID) %>% mutate(last_mod_ts = max(d_832139544, d_770257102, d_264644252)) %>% ungroup()

all_data <- all_data %>% mutate(days_ver_M1 = as.numeric(difftime(as.POSIXct(ymd_hms(d_517311251)), as.POSIXct(ymd_hms(d_914594314)), units="days")),
                                days_ver_M2 = as.numeric(difftime(as.POSIXct(ymd_hms(d_832139544)), as.POSIXct(ymd_hms(d_914594314)), units="days")),
                                days_ver_M3 = as.numeric(difftime(as.POSIXct(ymd_hms(d_770257102)), as.POSIXct(ymd_hms(d_914594314)), units="days")),
                                days_ver_M4 = as.numeric(difftime(as.POSIXct(ymd_hms(d_264644252)), as.POSIXct(ymd_hms(d_914594314)), units="days")),
                                days_ver_last = as.numeric(difftime(as.POSIXct(ymd_hms(last_mod_ts)), as.POSIXct(ymd_hms(d_914594314)), units="days")),
                                ver_M1 = as.numeric(difftime(as.POSIXct(ymd_hms(d_517311251)), as.POSIXct(ymd_hms(d_914594314)), units="hours")),
                                ver_M2 = as.numeric(difftime(as.POSIXct(ymd_hms(d_832139544)), as.POSIXct(ymd_hms(d_914594314)), units="hours")),
                                ver_M3 = as.numeric(difftime(as.POSIXct(ymd_hms(d_770257102)), as.POSIXct(ymd_hms(d_914594314)), units="hours")),
                                ver_M4 = as.numeric(difftime(as.POSIXct(ymd_hms(d_264644252)), as.POSIXct(ymd_hms(d_914594314)), units="hours")),
                                ver_last = as.numeric(difftime(as.POSIXct(ymd_hms(last_mod_ts)), as.POSIXct(ymd_hms(d_914594314)), units="hours")),
                                ver_M1_mins=ver_M1*60,
                                ver_M2_mins=ver_M2*60,
                                ver_M3_mins=ver_M3*60,
                                ver_M4_mins=ver_M4*60)


Table4a = all_data %>% group_by(Recruit_Type) %>% filter(d_949302066==231311385) %>% 
  dplyr::summarize('N'=n(),
                   Min = min(ver_M1, na.rm = TRUE),
                   Q1 = quantile(ver_M1, 0.25, na.rm = TRUE),
                   Median = median(ver_M1, na.rm = TRUE),
                   Mean = mean(ver_M1, na.rm = TRUE), 
                   SD= sd(ver_M1, na.rm = TRUE),
                   Q3 = quantile(ver_M1, 0.75, na.rm = TRUE),
                   'Perc.85' = quantile(ver_M1, 0.85, na.rm = TRUE),
                   'Perc.90' = quantile(ver_M1, 0.90, na.rm = TRUE),
                   'Perc.95' = quantile(ver_M1, 0.95, na.rm = TRUE),
                   Max = max(ver_M1, na.rm = TRUE)) 


Table4a2 = all_data %>% filter(d_949302066==231311385) %>% 
  dplyr::summarize('N'=n(),
                   Min = min(ver_M1, na.rm = TRUE),
                   Q1 = quantile(ver_M1, 0.25, na.rm = TRUE),
                   Median = median(ver_M1, na.rm = TRUE),
                   Mean = mean(ver_M1, na.rm = TRUE), 
                   SD= sd(ver_M1, na.rm = TRUE),
                   Q3 = quantile(ver_M1, 0.75, na.rm = TRUE),
                   'Perc.85' = quantile(ver_M1, 0.85, na.rm = TRUE),
                   'Perc.90' = quantile(ver_M1, 0.90, na.rm = TRUE),
                   'Perc.95' = quantile(ver_M1, 0.95, na.rm = TRUE),
                   Max = max(ver_M1, na.rm = TRUE)) 


Table4a1 <- Table4a #need to keep Table4a's first column name consistent to bind it later in the code
names(Table4a1)[1] <- "Recruit Type"

knitr::kable(Table4a1,caption='Table 4.1 Time (in hours) from Verification to BOH Submission \n Stratified by Active and Passive Recruits', row.names=FALSE, align=c("l","c","c","c","c","c","c","c"),digits=2, booktabs = TRUE)%>% kable_styling(latex_options = "scale_down") 


knitr::kable(Table4a2,caption='Table 4.2 Time (in hours) from Verification to BOH Submission for All Participants',row.names=FALSE, align=c("l","c","c","c","c","c","c","c"),digits=2, booktabs = TRUE)%>% kable_styling(latex_options = "scale_down") 
```


```{r Table5, echo=FALSE, error=FALSE, message=FALSE, warning=FALSE}


Table4b = all_data %>%  filter(d_536735468==231311385) %>% 
  dplyr::summarize('N'=n(),
                   Min = min(ver_M2, na.rm = TRUE),
                   Q1 = quantile(ver_M2, 0.25, na.rm = TRUE),
                   Median = median(ver_M2, na.rm = TRUE),
                   Mean = mean(ver_M2, na.rm = TRUE), 
                   SD= sd(ver_M2, na.rm = TRUE),
                   Q3 = quantile(ver_M2, 0.75, na.rm = TRUE),
                   'Perc.85' = quantile(ver_M2, 0.85, na.rm = TRUE),
                   'Perc.90' = quantile(ver_M2, 0.90, na.rm = TRUE),
                   'Perc.95' = quantile(ver_M2, 0.95, na.rm = TRUE),
                   Max = max(ver_M2, na.rm = TRUE)) 
  



Table4c = all_data %>%  filter(d_976570371==231311385) %>% 
  dplyr::summarize('N'=n(),
                   Min = min(ver_M3, na.rm = TRUE),
                   Q1 = quantile(ver_M3, 0.25, na.rm = TRUE),
                   Median = median(ver_M3, na.rm = TRUE),
                   Mean = mean(ver_M3, na.rm = TRUE), 
                   SD= sd(ver_M3, na.rm = TRUE),
                   Q3 = quantile(ver_M3, 0.75, na.rm = TRUE),
                   'Perc.85' = quantile(ver_M3, 0.85, na.rm = TRUE),
                   'Perc.90' = quantile(ver_M3, 0.90, na.rm = TRUE),
                   'Perc.95' = quantile(ver_M3, 0.95, na.rm = TRUE),
                   Max = max(ver_M3, na.rm = TRUE)) 
  





Table4d = all_data %>%   filter(d_663265240==231311385) %>%
  dplyr::summarize('N'=n(),
                   Min = min(ver_M4, na.rm = TRUE),
                   Q1 = quantile(ver_M4, 0.25, na.rm = TRUE),
                   Median = median(ver_M4, na.rm = TRUE),
                   Mean = mean(ver_M4, na.rm = TRUE), 
                   SD= sd(ver_M4, na.rm = TRUE),
                   Q3 = quantile(ver_M4, 0.75, na.rm = TRUE),
                   'Perc.85' = quantile(ver_M4, 0.85, na.rm = TRUE),
                   'Perc.90' = quantile(ver_M4, 0.90, na.rm = TRUE),
                   'Perc.95' = quantile(ver_M4, 0.95, na.rm = TRUE),
                   Max = max(ver_M4, na.rm = TRUE))
  



Table4e = all_data %>%   filter(d_100767870==353358909) %>%
  dplyr::summarize('N'=n(),
                   Min = min(ver_last, na.rm = TRUE),
                   Q1 = quantile(ver_last, 0.25, na.rm = TRUE),
                   Median = median(ver_last, na.rm = TRUE),
                   Mean = mean(ver_last, na.rm = TRUE), 
                   SD= sd(ver_last, na.rm = TRUE),
                   Q3 = quantile(ver_last, 0.75, na.rm = TRUE),
                   'Perc.85' = quantile(ver_last, 0.85, na.rm = TRUE),
                   'Perc.90' = quantile(ver_last, 0.90, na.rm = TRUE),
                   'Perc.95' = quantile(ver_last, 0.95, na.rm = TRUE),
                   Max = max(ver_last, na.rm = TRUE))


tb5boh <- as.data.frame(Table4a2)

table4 <- rbind(tb5boh, Table4b, Table4c, Table4d, Table4e)

table4<- table4[, c(1:7, 9, 11)]

table4[,10] <- c("BOH", "MRE", "SAS", "LAW", "All")

table4<- table4[, c(10,1:9)]

current_colnames <- colnames(table4)
current_colnames[1] <- "Section"
colnames(table4) <- current_colnames

knitr::kable(table4,caption='Table 5. Time (in hours) from Verification to Initial Survey Module Submission',row.names=FALSE, align=c("l","c","c","c","c","c","c","c"),digits=2, booktabs = TRUE)%>% kable_styling(latex_options = "scale_down") 

```



\FloatBarrier

```{r Table4_trend1, echo=FALSE, error=FALSE, message=FALSE, warning=FALSE, results='asis', include=FALSE}



combined_plot <- ggplot(all_data, aes(x = as.Date(d_914594314))) +
  stat_summary(aes(y = ver_M1_mins, color = "BOH"), fun = "mean", geom = "line", size = 0.5) +
  stat_summary(aes(y = ver_M2_mins, color = "MRE"), fun = "mean", geom = "line", size = 0.5) +
  stat_summary(aes(y = ver_M3_mins, color = "SAS"), fun = "mean", geom = "line", size = 0.5) +
  stat_summary(aes(y = ver_M4_mins, color = "LAW"), fun = "mean", geom = "line", size = 0.5) +
  scale_x_date(name = "Date", date_labels = "%y-%m-%d", date_breaks = "2 weeks", expand = c(0, 0)) +
  scale_y_continuous(name = "Time (in minutes)", limits = c(-10, 450), expand = c(0, 0)) +
  theme(
    panel.background = element_blank(),
    legend.position = "bottom",
    legend.title = element_text(face = "bold"),
    axis.line = element_line(size = 0.2),
    axis.text.x = element_text(angle = 60, hjust = 1),
    axis.title.x = element_text(size = 14, face = "bold"),
    axis.title.y = element_text(size = 14, face = "bold", color = "black"),
    plot.title = element_text(hjust = 0.5, size = 12, face = "bold")
  ) +
  theme(
    plot.caption = element_text(hjust = 0),
    legend.title = element_text(size = 8.5)
  ) +
  labs(caption = "Survey Submission Times greater than 450 minutes (7.5 hours) have been excluded to 
       properly view the average Submission Time frames.") +
  ggtitle(label = "Figure 1. Overall Weekly Average Time (in minutes) \n from Verification to Initial Survey Submission") + 
  labs(color = "Initial Survey")

# Print or display the combined plot
print(combined_plot)



```


\FloatBarrier
```{r Table4_trends2, echo=FALSE, error=FALSE, message=FALSE, warning=FALSE, results='asis', include=FALSE}

timetrend2a <- ggplot(all_data, aes(x = as.Date(d_914594314), y = ver_M1_mins, color = Recruit_Type)) +
  stat_summary(fun = "mean", geom = "line", size = 0.5) +
  scale_x_date(name = "Date", date_labels = "%y-%m-%d", date_breaks = "2 weeks", expand = c(0, 0)) +
  scale_y_continuous(name = "Time (in minutes)", limits = c(-10, 450), expand = c(0, 0)) +
  theme(
    panel.background = element_blank(),
    legend.position = "bottom",
    axis.line = element_line(size = 0.2),
    axis.text.x = element_text(angle = 60, hjust = 1),
    axis.title.x = element_text(size = 14, face = "bold"),
    axis.title.y = element_text(size = 14, face = "bold", color = "black"),
    plot.title = element_text(hjust = 0.5, size = 12, face = "bold")
  ) +
  theme(
    plot.caption = element_text(hjust = 0),
    legend.title = element_text(size = 8.5)
  ) +
  labs(caption = "Survey Submission Times greater than 450 minutes (7.5 hours) have been excluded to 
       properly view the average Submission Time frames.") +
  ggtitle(label = "Figure 2.1 Weekly Average Time (in minutes) from Verification to BOH Submission") +
  guides(color = guide_legend(title = "Recruitment Status"))

timetrend2a



timetrend2b <- ggplot(all_data, aes(x = as.Date(d_914594314), y = ver_M2_mins, color = Recruit_Type)) +
  stat_summary(fun = "mean", geom = "line", size = 0.5) +
  scale_x_date(name = "Date", date_labels = "%y-%m-%d", date_breaks = "2 weeks", expand = c(0, 0)) +
  scale_y_continuous(name = "Time (in minutes)", limits = c(-10, 450), expand = c(0, 0)) +
  theme(
    panel.background = element_blank(),
    legend.position = "bottom",
    axis.line = element_line(size = 0.2),
    axis.text.x = element_text(angle = 60, hjust = 1),
    axis.title.x = element_text(size = 14, face = "bold"),
    axis.title.y = element_text(size = 14, face = "bold", color = "black"),
    plot.title = element_text(hjust = 0.5, size = 12, face = "bold")
  ) +
  theme(
    plot.caption = element_text(hjust = 0),
    legend.title = element_text(size = 8.5)
  ) +
  labs(caption = "Survey Submission Times greater than 450 minutes (7.5 hours) have been excluded to 
       properly view the average Submission Time frames.") +
  ggtitle(label = "Figure 2.2 Weekly Average Time (in minutes) from Verification to MRE Submission") +
  guides(color = guide_legend(title = "Recruitment Status"))

timetrend2b



timetrend2c <- ggplot(all_data, aes(x = as.Date(d_914594314), y = ver_M3_mins, color = Recruit_Type)) +
  stat_summary(fun = "mean", geom = "line", size = 0.5) +
  scale_x_date(name = "Date", date_labels = "%y-%m-%d", date_breaks = "2 weeks", expand = c(0, 0)) +
  scale_y_continuous(name = "Time (in minutes)", limits = c(-10, 450), expand = c(0, 0)) +
  theme(
    panel.background = element_blank(),
    legend.position = "bottom",
    axis.line = element_line(size = 0.2),
    axis.text.x = element_text(angle = 60, hjust = 1),
    axis.title.x = element_text(size = 14, face = "bold"),
    axis.title.y = element_text(size = 14, face = "bold", color = "black"),
    plot.title = element_text(hjust = 0.5, size = 12, face = "bold")
  ) +
  theme(
    plot.caption = element_text(hjust = 0),
    legend.title = element_text(size = 8.5)
  ) +
  labs(caption = "Survey Submission Times greater than 450 minutes (7.5 hours) have been excluded to 
       properly view the average Submission Time frames.") +
  ggtitle(label = "Figure 2.3 Weekly Average Time (in minutes) from Verification to SAS Submission") +
  guides(color = guide_legend(title = "Recruitment Status"))

timetrend2c



timetrend2d <- ggplot(all_data, aes(x = as.Date(d_914594314), y = ver_M4_mins, color = Recruit_Type)) +
  stat_summary(fun = "mean", geom = "line", size = 0.5) +
  scale_x_date(name = "Date", date_labels = "%y-%m-%d", date_breaks = "2 weeks", expand = c(0, 0)) +
  scale_y_continuous(name = "Time (in minutes)", limits = c(-10, 450), expand = c(0, 0)) +
  theme(
    panel.background = element_blank(),
    legend.position = "bottom",
    axis.line = element_line(size = 0.2),
    axis.text.x = element_text(angle = 60, hjust = 1),
    axis.title.x = element_text(size = 14, face = "bold"),
    axis.title.y = element_text(size = 14, face = "bold", color = "black"),
    plot.title = element_text(hjust = 0.5, size = 12, face = "bold")
  ) +
  theme(
    plot.caption = element_text(hjust = 0),
    legend.title = element_text(size = 8.5)
  ) +
  labs(caption = "Survey Submission Times greater than 450 minutes (7.5 hours) have been excluded to 
       properly view the average Submission Time frames.") +
  ggtitle(label = "Figure 2.4 Weekly Average Time (in minutes) from Verification to LAW Submission") +
  guides(color = guide_legend(title = "Recruitment Status"))

timetrend2d

```





\newpage


```{r Submission_Minutes, echo=FALSE, warning = FALSE}

all_data <- all_data %>% mutate(comp_tm_M1 = as.numeric(difftime(as.POSIXct(ymd_hms(d_517311251)), as.POSIXct(ymd_hms(d_205553981)), units="hours")),
                                comp_tm_M2 = as.numeric(difftime(as.POSIXct(ymd_hms(d_832139544)), as.POSIXct(ymd_hms(d_541836531)), units="hours")),
                                comp_tm_M3 = as.numeric(difftime(as.POSIXct(ymd_hms(d_770257102)), as.POSIXct(ymd_hms(d_386488297)), units="hours")),
                                comp_tm_M4 = as.numeric(difftime(as.POSIXct(ymd_hms(d_264644252)), as.POSIXct(ymd_hms(d_452942800)), units="hours")))

all_data <- all_data %>%  
  mutate(m1_comp_mins=(comp_tm_M1*60),
         m2_comp_mins=(comp_tm_M2*60),
         m3_comp_mins=(comp_tm_M3*60),
         m4_comp_mins=(comp_tm_M4*60))


Module1_in_minutes <- all_data %>% filter(d_949302066==231311385) %>%
                                   mutate(time_frame=case_when(m1_comp_mins<5 ~ "Under 5 minutes",
                                                               m1_comp_mins<10 ~ "5 to 10 minutes",
                                                               m1_comp_mins<15 ~ "10 to 15 minutes",
                                                               m1_comp_mins<20 ~ "15 to 20 minutes",
                                                               m1_comp_mins<30 ~ "20 to 30 minutes",
                                                               m1_comp_mins<45 ~ "30 to 45 minutes",
                                                               m1_comp_mins<60 ~ "45 to 60 minutes",
                                                               m1_comp_mins>=60 ~ "60 minutes+",
                                                               is.na(d_517311251) | is.na(d_205553981) ~ "Missing Time Stamp(s)"))
Module1_in_minutes$time_frame <- factor(Module1_in_minutes$time_frame,levels=c("Under 5 minutes","5 to 10 minutes","10 to 15 minutes","15 to 20 minutes","20 to 30 minutes","30 to 45 minutes","45 to 60 minutes","60 minutes+", "Missing Time Stamp(s)"))
  
Module1_in_minutes_summary <- Module1_in_minutes %>% dplyr::group_by(time_frame) %>%  dplyr::summarize(n=n(), percentage=100*n/nrow(.))  %>% dplyr::ungroup() %>%  
  mutate(cumulative_percentage = cumsum(percentage)) %>% dplyr::select(time_frame, n, percentage, cumulative_percentage) 

summary_row <- Module1_in_minutes_summary %>% 
  summarize(n = sum(n), percentage = 100, cumulative_percentage = 100,
            time_frame = "Total") 

Module1_in_minutes_summary <- bind_rows(Module1_in_minutes_summary, summary_row)


table6.1_sum <- Module1_in_minutes_summary %>% mutate(np = paste0(n, " (", round(percentage, digits=2), "%)"),
                                                      cumulative_percentage = paste0(round(cumulative_percentage, digits=2), "%")) %>% select(time_frame, np, cumulative_percentage)

knitr::kable(table6.1_sum, caption='Table 6.1 BOH Section Initial Survey Submission Time \n from Start to Submit for Verified Participants', col.names=c("Submission Time", "Total Participants", "Cumulative Percentage"), row.names=FALSE, align=c("l","c","c"),digits=1, booktabs = TRUE) %>%  add_indent(c(1:9))  %>% kable_styling(latex_options = "hold_position")



Module2_in_minutes <- all_data %>% filter(d_536735468==231311385) %>% 
                                   mutate(time_frame=case_when(m2_comp_mins<5 ~ "Under 5 minutes",
                                                               m2_comp_mins<10 ~ "5 to 10 minutes",
                                                               m2_comp_mins<15 ~ "10 to 15 minutes",
                                                               m2_comp_mins<20 ~ "15 to 20 minutes",
                                                               m2_comp_mins<30 ~ "20 to 30 minutes",
                                                               m2_comp_mins<45 ~ "30 to 45 minutes",
                                                               m2_comp_mins<60 ~ "45 to 60 minutes",
                                                               m2_comp_mins>=60 ~ "60 minutes+",
                                                               is.na(d_832139544) | is.na(d_541836531) ~ "Missing Time Stamp(s)"))

Module2_in_minutes$time_frame <- factor(Module2_in_minutes$time_frame,levels=c("Under 5 minutes","5 to 10 minutes","10 to 15 minutes","15 to 20 minutes","20 to 30 minutes","30 to 45 minutes","45 to 60 minutes","60 minutes+", "Missing Time Stamp(s)"))
Module2_in_minutes_summary <- Module2_in_minutes %>% dplyr::group_by(time_frame) %>%  dplyr::summarize(n=n(), percentage=100*n/nrow(.))  %>% dplyr::ungroup() %>%  
  mutate(cumulative_percentage = cumsum(percentage)) %>% dplyr::select(time_frame, n, percentage, cumulative_percentage) 

summary_row <- Module2_in_minutes_summary %>% 
  summarize(n = sum(n), percentage = 100, cumulative_percentage = 100,
            time_frame = "Total") 

Module2_in_minutes_summary <- bind_rows(Module2_in_minutes_summary, summary_row)


table6.2_sum <- Module2_in_minutes_summary %>% mutate(np = paste0(n, " (", round(percentage, digits=2), "%)"),
                                                      cumulative_percentage = paste0(round(cumulative_percentage, digits=2), "%")) %>% select(time_frame, np, cumulative_percentage)

knitr::kable(table6.2_sum, caption='Table 6.2 MRE Section Initial Survey Submission Time \n from Start to Submit for Verified Participants', col.names=c("Submission Time", "Total Participants", "Cumulative Percentage"), row.names=FALSE, align=c("l","c"),digits=1, booktabs = TRUE) %>%  add_indent(c(1:9))  %>% kable_styling(latex_options = "hold_position")




Module3_in_minutes <- all_data %>%  filter(d_976570371==231311385) %>%
                                   mutate(time_frame=case_when(m3_comp_mins<5 ~ "Under 5 minutes",
                                                               m3_comp_mins<10 ~ "5 to 10 minutes",
                                                               m3_comp_mins<15 ~ "10 to 15 minutes",
                                                               m3_comp_mins<20 ~ "15 to 20 minutes",
                                                               m3_comp_mins<30 ~ "20 to 30 minutes",
                                                               m3_comp_mins<45 ~ "30 to 45 minutes",
                                                               m3_comp_mins<60 ~ "45 to 60 minutes",
                                                               m3_comp_mins>=60 ~ "60 minutes+",
                                                               is.na(d_770257102) | is.na(d_386488297) ~ "Missing Time Stamp(s)"))

Module3_in_minutes$time_frame <- factor(Module3_in_minutes$time_frame,levels=c("Under 5 minutes","5 to 10 minutes","10 to 15 minutes","15 to 20 minutes","20 to 30 minutes","30 to 45 minutes","45 to 60 minutes","60 minutes+", "Missing Time Stamp(s)"))

Module3_in_minutes_summary <- Module3_in_minutes %>% dplyr::group_by(time_frame) %>%  dplyr::summarize(n=n(), percentage=100*n/nrow(.))  %>% dplyr::ungroup() %>%  
  mutate(cumulative_percentage = cumsum(percentage)) %>% dplyr::select(time_frame, n, percentage, cumulative_percentage) 

summary_row <- Module3_in_minutes_summary %>% 
  summarize(n = sum(n), percentage = 100, cumulative_percentage = 100,
            time_frame = "Total") 

Module3_in_minutes_summary <- bind_rows(Module3_in_minutes_summary, summary_row)

table6.3_sum <- Module3_in_minutes_summary %>% mutate(np = paste0(n, " (", round(percentage, digits=2), "%)"),
                                                      cumulative_percentage = paste0(round(cumulative_percentage, digits=2), "%")) %>% select(time_frame, np, cumulative_percentage)

knitr::kable(table6.3_sum, caption='Table 6.3 SAS Section Initial Survey Submission Time \n from Start to Submit for Verified Participants', col.names=c("Submission Time", "Total Participants", "Cumulative Percentage"), row.names=FALSE, align=c("l","c"),digits=1, booktabs = TRUE) %>%  add_indent(c(1:9)) %>% kable_styling(latex_options = "hold_position")



Module4_in_minutes <- all_data %>%  filter(d_663265240==231311385) %>%
                                   mutate(time_frame=case_when(m4_comp_mins<5 ~ "Under 5 minutes",
                                                               m4_comp_mins<10 ~ "5 to 10 minutes",
                                                               m4_comp_mins<15 ~ "10 to 15 minutes",
                                                               m4_comp_mins<20 ~ "15 to 20 minutes",
                                                               m4_comp_mins<30 ~ "20 to 30 minutes",
                                                               m4_comp_mins<45 ~ "30 to 45 minutes",
                                                               m4_comp_mins<60 ~ "45 to 60 minutes",
                                                               m4_comp_mins>=60 ~ "60 minutes+",
                                                               is.na(d_264644252) | is.na(d_452942800) ~ "Missing Time Stamp(s)"))


Module4_in_minutes$time_frame <- factor(Module4_in_minutes$time_frame,levels=c("Under 5 minutes","5 to 10 minutes","10 to 15 minutes","15 to 20 minutes","20 to 30 minutes","30 to 45 minutes","45 to 60 minutes","60 minutes+", "Missing Time Stamp(s)"))

Module4_in_minutes_summary <- Module4_in_minutes %>% dplyr::group_by(time_frame) %>%  dplyr::summarize(n=n(), percentage=100*n/nrow(.))  %>% dplyr::ungroup() %>%  
  mutate(cumulative_percentage = cumsum(percentage)) %>% dplyr::select(time_frame, n, percentage, cumulative_percentage) 

summary_row <- Module4_in_minutes_summary %>% 
  summarize(n = sum(n), percentage = 100, cumulative_percentage = 100,
            time_frame = "Total") 

Module4_in_minutes_summary <- bind_rows(Module4_in_minutes_summary, summary_row)

table6.4_sum <- Module4_in_minutes_summary %>% mutate(np = paste0(n, " (", round(percentage, digits=2), "%)"),
                                                      cumulative_percentage = paste0(round(cumulative_percentage, digits=2), "%")) %>% select(time_frame, np, cumulative_percentage)

knitr::kable(table6.4_sum, caption='Table 6.4 LAW Section Initial Survey Submission Time \n from Start to Submit for Verified Participants', col.names=c("Submission Time", "Total Participants", "Cumulative Percentage"), row.names=FALSE, align=c("l","c"),digits=1, booktabs = TRUE) %>%  add_indent(c(1:9)) %>% kable_styling(latex_options = "hold_position")


```


\FloatBarrier

```{r Table7,echo=FALSE,error=FALSE,message=FALSE,results='asis'}


Table7a = all_data %>% 
  dplyr::summarize('N'=n(),
                   Min = min(m1_comp_mins, na.rm = TRUE),
                   Q1 = quantile(m1_comp_mins, 0.25, na.rm = TRUE),
                   Median = median(m1_comp_mins, na.rm = TRUE),
                   Mean = mean(m1_comp_mins, na.rm = TRUE), 
                   SD= sd(m1_comp_mins, na.rm = TRUE),
                   Q3 = quantile(m1_comp_mins, 0.75, na.rm = TRUE),
                   'Perc.85' = quantile(m1_comp_mins, 0.85, na.rm = TRUE),
                   'Perc.90' = quantile(m1_comp_mins, 0.90, na.rm = TRUE),
                   'Perc.95' = quantile(m1_comp_mins, 0.95, na.rm = TRUE),
                   Max = max(m1_comp_mins, na.rm = TRUE)) 

Table7b = all_data %>%  
  dplyr::summarize('N'=n(),
                   Min = min(m2_comp_mins, na.rm = TRUE),
                   Q1 = quantile(m2_comp_mins, 0.25, na.rm = TRUE),
                   Median = median(m2_comp_mins, na.rm = TRUE),
                   Mean = mean(m2_comp_mins, na.rm = TRUE), 
                   SD= sd(m2_comp_mins, na.rm = TRUE),
                   Q3 = quantile(m2_comp_mins, 0.75, na.rm = TRUE),
                   'Perc.85' = quantile(m2_comp_mins, 0.85, na.rm = TRUE),
                   'Perc.90' = quantile(m2_comp_mins, 0.90, na.rm = TRUE),
                   'Perc.95' = quantile(m2_comp_mins, 0.95, na.rm = TRUE),
                   Max = max(m2_comp_mins, na.rm = TRUE)) 

Table7c = all_data %>% 
  dplyr::summarize('N'=n(),
                   Min = min(m3_comp_mins, na.rm = TRUE),
                   Q1 = quantile(m3_comp_mins, 0.25, na.rm = TRUE),
                   Median = median(m3_comp_mins, na.rm = TRUE),
                   Mean = mean(m3_comp_mins, na.rm = TRUE), 
                   SD= sd(m3_comp_mins, na.rm = TRUE),
                   Q3 = quantile(m3_comp_mins, 0.75, na.rm = TRUE),
                   'Perc.85' = quantile(m3_comp_mins, 0.85, na.rm = TRUE),
                   'Perc.90' = quantile(m3_comp_mins, 0.90, na.rm = TRUE),
                   'Perc.95' = quantile(m3_comp_mins, 0.95, na.rm = TRUE),
                   Max = max(m3_comp_mins, na.rm = TRUE)) 
  
Table7d = all_data %>% 
  dplyr::summarize('N'=n(),
                   Min = min(m4_comp_mins, na.rm = TRUE),
                   Q1 = quantile(m4_comp_mins, 0.25, na.rm = TRUE),
                   Median = median(m4_comp_mins, na.rm = TRUE),
                   Mean = mean(m4_comp_mins, na.rm = TRUE), 
                   SD= sd(m4_comp_mins, na.rm = TRUE),
                   Q3 = quantile(m4_comp_mins, 0.75, na.rm = TRUE),
                   'Perc.85' = quantile(m4_comp_mins, 0.85, na.rm = TRUE),
                   'Perc.90' = quantile(m4_comp_mins, 0.90, na.rm = TRUE),
                   'Perc.95' = quantile(m4_comp_mins, 0.95, na.rm = TRUE),
                   Max = max(m4_comp_mins, na.rm = TRUE))




Table7 <- rbind(Table7a, Table7b, Table7c, Table7d)

Table7<- Table7[, c(1:7, 9, 11)]

Table7[,10] <- c("BOH", "MRE", "SAS", "LAW")

Table7<- Table7[, c(10,1:9)]

current_colnames <- colnames(Table7)
current_colnames[1] <- "Section"
colnames(Table7) <- current_colnames

knitr::kable(Table7,caption='Table 7. Time (in minutes) from Start to Submit of Initial Survey Modules',row.names=FALSE, align=c("l","c","c","c","c","c","c","c"),digits=2, booktabs = TRUE)%>% kable_styling(latex_options = "HOLD_position") 


```








```{r Section8, echo=FALSE, warning = FALSE}



cannot_ver <- data_c %>%  filter(d_821247024==219863910 & d_512820379==486306141) %>%  
  mutate(sect_comp= case_when((d_949302066==231311385 | d_536735468==231311385 | d_976570371==231311385 | d_663265240==231311385) ~ "At Least One",
                              TRUE ~ "None"))

Numb5 <- cannot_ver %>% group_by(sect_comp) %>%    dplyr::summarize(n=n(), percentage=100*n/nrow(.))  %>% dplyr::ungroup() %>%  dplyr::select(sect_comp, n, percentage)

Numb5_table <- Numb5 %>% mutate(np = paste0(n, " (", round(percentage, digits=2), "%)")) %>% select(sect_comp, np)

Numb5_table[dim(Numb5_table)[[1]]+1 , ] <- list("Total", paste(sum(Numb5$n), " (100%)"))

knitr::kable(Numb5_table, caption='Table 8. Inital Survey Submission Status among Active Recruits who Could Not be Verified', col.names=c("Sections Submitted", "Active recruits"), row.names=FALSE, align=c("l","c"),digits=1, booktabs = TRUE) %>%  add_indent(c(1:2)) %>% kable_styling(latex_options = "hold_position")


## do this with other wide tables!! kable_styling(latex_options = "hold_position")

```


\newpage

```{r Menstrual, echo=FALSE, warning = FALSE, message=FALSE}


mens_ccc <- "WITH combined_survey AS (
  SELECT Connect_ID
  FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.bioSurvey_v1_JP`
  WHERE d_112151599 = '353358909'

  UNION DISTINCT

  SELECT Connect_ID
  FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.clinicalBioSurvey_v1_JP`
  WHERE d_112151599 = '353358909'
)

SELECT p.Connect_ID, p.d_459098666, p.d_253883960, p.d_265193023
FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP` p
JOIN combined_survey c ON p.Connect_ID = c.Connect_ID
WHERE (p.d_253883960 = '231311385' OR p.d_265193023 = '231311385')"


mens_table_cc <- bq_project_query(project_cc, mens_ccc)
menstrual <- bq_table_download(mens_table_cc, bigint = "integer64")

mens_surv <- menstrual %>%  mutate(menst=case_when(d_459098666==231311385~"Submitted",
                                                   d_459098666==615768760~"Started",
                                                   d_459098666==972455046~"Not Started"),
                                setting= case_when(d_265193023=='231311385' ~ "Among Research Collections",
                                                   d_253883960=='231311385' ~ "Among Clinical Collections")) %>% 
      tbl_cross(
    row = menst,
    col = setting,
    digits=c(0,1),
    percent = "col",
    label=list(menst="Submission Status",
                setting = " "),
    missing="ifany",
    margin_text="Total") 


mens_surv_status <- 
  mens_surv %>%
  #bold_labels() %>%
  #italicize_levels() %>%
  modify_header(stat_0 = "Total") %>%
  modify_caption("Table 9. Menstrual Cycle Survey Submission Status for Eligible Participants") %>%
  as_kable_extra(escape = FALSE, addtl_fmt = TRUE)

add_footnote(mens_surv_status, "Note: Eligible participants are those that completed the Clinical Biospecimen Blood and Urine Survey or the Research Biospecimen Blood, Urine and Mouthwash survey. On that survey they must also have answered yes to SrvBlU_MENST60_v2r0, indicating that they have had a menstrual period in the last 60 days.", notation = "none")


```





```{r SSN, echo=FALSE, warning = FALSE}
# ssn_surv = all_data %>%  mutate(started=case_when(d_126331570==615768760 ~ "Started",
#                                                 d_126331570==231311385 ~ "Submitted",
#                                                 TRUE ~ "Not Started"),
#                                 provided4 =case_when(d_311580100==353358909 ~ "Full SSN Given",
#                                                      d_914639140==353358909 ~ "Partial SSN Given",
#                                                      TRUE ~ "No SSN given"))
ssn_surv = all_data %>%  mutate(provided4 =case_when(d_311580100==353358909 ~ "Full SSN",
                                                     d_914639140==353358909 ~ "Partial SSN",
                                                     TRUE ~ "No SSN"))
ssn_surv$provided4<- factor(ssn_surv$provided4,levels=c("Full SSN", "Partial SSN", "No SSN"))

ssn_surv = ssn_surv %>% mutate(started=case_when(d_126331570==615768760 ~ "Started",
                           d_126331570==231311385 ~ "Submitted",
                           TRUE ~ "Not Started"))



 
ssn_surv %>% tbl_cross(
    row = started,
    col = provided4,
    digits=c(0,1),
    percent = "row",
    label=list(started="Submission Status",
                provided4 = "Portion of SSN Given"),
    missing="ifany",
    margin_text="Total") %>% 


# ssn_surv %>%
#   #bold_labels() %>%
  #italicize_levels() %>%
  modify_header(stat_0 = "Total") %>%
  modify_caption("Table 10. Portion of SSN Given by Submission Status of SSN Survey") %>%
  as_kable_extra(escape = FALSE, addtl_fmt = TRUE)

```



