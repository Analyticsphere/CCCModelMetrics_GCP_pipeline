
---
title: "Weekly CCC Metrics for Sections BOH, LAW, MRE, and SAS"
author: "Kelsey Sanchez"
date: 'Data Extracted and Report Ran: `r Sys.Date()`'
header-includes: 
  \usepackage[labelformat=empty]{caption} 
  \usepackage{placeins} 
  \usepackage{booktabs}
  \usepackage{pdflscape}
  
output:
  pdf_document:
    extra_dependencies: ["float"]
    toc: no
    keep_tex: yes
    fig_width: 7
    fig_height: 5
    fig_caption: yes
    df_print: paged
---






```{r libraries, include=FALSE, warning=FALSE}

 # \usepackage{caption}
 # \captionsetup[figure]{labelformat=empty}


#old.packages()
#update.packages("tinytex")


library(bigrquery)
library(dplyr)
library(gmodels)
library(epiDisplay)
library(lubridate)
library(tidyverse)
library(knitr)
#install_tinytex()
#library(tinytex)
#library(vtable)
library(kableExtra)
library(gtsummary)


bq_auth()


# ```{r setup, include=FALSE}
# options(width = 80)
# options(tinytex.verbose = TRUE) --- didn't work
# ```

```


In order of how the sections appear on MyConnect, the Initial Survey Sections are:  

BOH= Background and Overall Health (Module 1)  

LAW= Where you Live and Work (Module 4)

MRE= Medications, Reproductive Health, Exercise, and Sleep (Module 2)

SAS= Smoking, Alcohol, and Sun Exposure (Module 3)





```{r BQPull, include=FALSE}
knitr::opts_chunk$set(comment = NA)

project_cc = "nih-nci-dceg-connect-prod-6d04"
queryreccc <- "SELECT  Connect_ID, d_512820379, d_821247024, d_914594314, d_832139544, d_949302066 , d_205553981, 
d_536735468 , d_976570371, d_663265240, d_265193023, d_222161762,d_770257102, d_264644252, d_265193023, d_541836531, 
d_386488297, d_452942800, d_517311251 , d_822499427, d_126331570, d_914639140, d_311580100, d_827220437, d_100767870, 
d_831041022, d_255077064
FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP` where Connect_ID IS NOT NULL  and (d_512820379='486306141' OR d_512820379='854703046') " 

#and d_831041022='104430631'-- not needed, according to 3/12/24 decisions we'll be keeping participant journeys in overall counts

rec_table_cc <- bq_project_query(project_cc, queryreccc)
data_c <- bq_table_download(rec_table_cc, bigint = "integer64")


#need this separate filter to look at participants unable to be verified
data_ccc <- data_c %>%  filter(d_821247024==197316935) 


data_tib= as_tibble(data_ccc) 


modules <- data_tib[,c("Connect_ID","d_512820379","d_949302066","d_536735468","d_976570371","d_663265240", "d_914594314")] 
mods <- c("d_949302066","d_536735468","d_976570371","d_663265240")
modules$modules <- 0
modules$none <-0
for(i in 1:length(mods)){
  module <- modules[,mods[i]]
  count <- ifelse((!is.na(module) & module ==231311385), 1, 0)
  modules$modules <- count+modules$modules
  count1 <- ifelse((!is.na(module) & module==972455046), 1, 0)
  modules$none <- count1+modules$none
}



length(modules[which(modules$modules==3 & modules$d_663265240==231311385 & modules$d_536735468==231311385),])

modules1 <- modules %>% mutate(process = case_when(as.character(modules) =='0' ~ "None",
                                                   d_949302066 == '231311385' & as.character(modules) == '1' ~ "BOH Section only",
                                                   as.character(modules) == '2' & d_949302066 == '231311385' & d_536735468 == '231311385' ~ "BOH and MRE Sections" ,
                                                   as.character(modules) =='2' & d_949302066 == '231311385' & d_976570371 == '231311385' ~ "BOH and SAS Sections" , 
                                                   as.character(modules) =='2' & d_949302066 == '231311385' & d_663265240 == '231311385' ~ "BOH and LAW Sections" ,  
                                                   as.character(modules) =='3' & d_949302066 == '231311385' & d_536735468 == '231311385' & d_976570371 == '231311385' ~ "BOH, MRE, and SAS Sections" ,  
                                                   as.character(modules) =='3' & d_949302066 == '231311385' & d_976570371 == '231311385' & d_663265240 == '231311385'~ "BOH, SAS, and LAW Sections" , 
                                                   as.character(modules) =='3' & d_949302066 == '231311385' & d_536735468 == '231311385' & d_663265240 == '231311385' ~ "BOH, MRE, and LAW Sections",   
                                                   as.character(modules) =='4' ~ "All")) 

tab1(modules1$process, decimal=2,sort.group = "decreasing", cum.percent = TRUE)$output.table


#completion <- modules1 %>% select(Connect_ID, process) #have no idea why this isn't working
completion <- modules1[, c(1,10)]
all_data <- left_join(data_tib, completion, by="Connect_ID")


all_data <- all_data %>%  mutate(Site = case_when(d_827220437==472940358 ~ "Baylor Scott and White Health",
                                                  d_827220437==125001209 ~ "KP Colorado",
                                                  d_827220437==327912200 ~ "KP Georgia",
                                                  d_827220437==300267574 ~ "KP Hawaii",
                                                  d_827220437==452412599 ~ "KP Northwest",
                                                  d_827220437==548392715 ~ "Henry Ford",
                                                  d_827220437==531629870 ~ "HealthPartners",
                                                  d_827220437==303349821 ~ "Marshfield",
                                                  d_827220437==657167265 ~ "Sanford",
                                                  d_827220437==809703864 ~ "UChicago"),
                                 BSL_compl = case_when(d_100767870==353358909 ~ "All Baseline Modules Completed",
                                                       TRUE ~ "One or More Baseline Modules Not Completed"),
                                 Pref_lang=case_when(d_255077064 == 773342525 ~ "Spanish",
                                                     TRUE ~ "English"),
                                 Recruit_Type= case_when(d_512820379==486306141 ~ "Active",
                                                  d_512820379==854703046 ~ "Passive"),
                                 m1_comp_mins = as.numeric(difftime(as.POSIXct(ymd_hms(d_517311251)), as.POSIXct(ymd_hms(d_205553981)), units="hours"))*60,
                                 m2_comp_mins = as.numeric(difftime(as.POSIXct(ymd_hms(d_832139544)), as.POSIXct(ymd_hms(d_541836531)), units="hours"))*60,
                                 m3_comp_mins = as.numeric(difftime(as.POSIXct(ymd_hms(d_770257102)), as.POSIXct(ymd_hms(d_386488297)), units="hours"))*60,
                                 m4_comp_mins = as.numeric(difftime(as.POSIXct(ymd_hms(d_264644252)), as.POSIXct(ymd_hms(d_452942800)), units="hours"))*60)
all_data$Site <- factor(all_data$Site, levels=c("Baylor Scott and White Health","HealthPartners", "Henry Ford","Marshfield","Sanford","UChicago","KP Colorado","KP Georgia", "KP Hawaii","KP Northwest"))

```

 \newpage

```{r newTable1, echo=FALSE, warning=FALSE, message=FALSE, results='asis'}


comp_by_site <- all_data  %>% select(Site, BSL_compl) %>% 
  tbl_cross(col =BSL_compl,
                  row = Site, 
                   percent = "row",
                   digits= c(0,1),
                   label= c(Site~ "Site", BSL_compl ~ " "),
                   missing="ifany",
                   missing_text="0 ( 0 %)") 

comp_by_site_totals <- as.data.frame(comp_by_site)
comp_by_site_totals <- comp_by_site_totals[-1, ]

total_rows <- nrow(comp_by_site_totals)
knitr::kable(comp_by_site_totals , 
             caption='Table 1.Completion of Initial Surveys by Site', 
             row.names=FALSE,align=c("l","c","c","c"),
             col.names=c("", "All Completed", "One or More Not Completed", "Total"), escape=F,
             booktabs = TRUE) %>%  
  add_indent(seq(1, total_rows - 1))  %>% 
  kable_styling(latex_options = "scale_down") # %>%  column_spec(3:4, width = "4cm")


```


 
 \newpage
 
```{r Table2, echo=FALSE, warning=FALSE, message=FALSE}
#Make the automated table

all_srvy_comp <- all_data  %>% select(process, Recruit_Type) %>% 
  tbl_cross(  col =Recruit_Type,
                  row = process, 
                   percent = "column",
                   digits= c(0,1),
                   label= c(process~ "Sections Submitted", Recruit_Type ~ " "),
                   missing="ifany",
                   missing_text="0 ( 0 %)") 

all_srvy_comp_totals <- as.data.frame(all_srvy_comp)
all_srvy_comp_totals <- all_srvy_comp_totals[-1, ]
all_srvy_comp_totals <- all_srvy_comp_totals[c(9,5, 2:4,6:8, 1,10), ]





overall_surveys <- knitr::kable(all_srvy_comp_totals ,
                                col.names=c("Sections Submitted", "Active Verified","Passive Verified", "Total Verified"), 
                                caption='Table 2. Initial Survey Submission Among Verified Participants \n Stratified by Active and Passive Recruits', 
                                row.names=FALSE,align=c("l","c","c","c"), booktabs = TRUE) %>%  
  add_indent(seq(1, nrow(all_srvy_comp_totals) - 1))  %>%
  kable_styling(latex_options = "scale_down")

add_footnote(overall_surveys, "Note: All sections were in MyConnect on July 5,2022. There were 766 verified participants beore that date.", notation = "none")

```


```{r Table3, echo=FALSE, warning=FALSE, message=FALSE}

calculate_counts <- function(df, column_name, row_label) {
  total_rows <- dim(df)[[1]]
  value_counts <- sapply(c(972455046, 615768760, 231311385), function(value) {
    count <- sum(df[[column_name]] == value)
    formatted_count <- formatC(count, format = "f", big.mark = ",", digits = 0)
    percentage <- round(100 * count / total_rows, 1)
    paste0(formatted_count, " (", percentage, "%)")
  })
  total_label <- paste(formatC(total_rows, format = "f", big.mark = ",", digits = 0), "(100%)")
  c(row_label, value_counts, total_label)
}


section_comp <- data.frame(matrix(ncol =5, nrow = 4))


section_comp[1, ] <- calculate_counts(all_data, "d_949302066", "BOH")
section_comp[2, ] <- calculate_counts(all_data, "d_536735468", "MRE")
section_comp[3, ] <- calculate_counts(all_data, "d_976570371", "SAS")
section_comp[4, ] <- calculate_counts(all_data, "d_663265240", "LAW")


colnames(section_comp) <- c("Section", "Not Started", "Started", "Submitted", "Total Verified Participants")


knitr::kable(section_comp, 
             caption='Table 3: Initial Survey Section Submission Status Among Verified Participants', 
             col.names=c("Section", "Not Started", "Started", "Submitted", "Total Verified Participants"), 
             row.names=FALSE, align=c("l","c","c","c","c"), booktabs = TRUE) %>% 
  kable_styling(latex_options = "hold_position")


```






\newpage
\FloatBarrier


```{r Table4.1, echo=FALSE, error=FALSE, message=FALSE, warning=FALSE, results='asis'}


all_data <- all_data %>% group_by(Connect_ID) %>% mutate(last_mod_ts = max(d_832139544, d_770257102, d_264644252)) %>% ungroup()

all_data <- all_data %>% mutate(days_ver_M1 = as.numeric(difftime(as.POSIXct(ymd_hms(d_517311251)), as.POSIXct(ymd_hms(d_914594314)), units="days")),
                                days_ver_M2 = as.numeric(difftime(as.POSIXct(ymd_hms(d_832139544)), as.POSIXct(ymd_hms(d_914594314)), units="days")),
                                days_ver_M3 = as.numeric(difftime(as.POSIXct(ymd_hms(d_770257102)), as.POSIXct(ymd_hms(d_914594314)), units="days")),
                                days_ver_M4 = as.numeric(difftime(as.POSIXct(ymd_hms(d_264644252)), as.POSIXct(ymd_hms(d_914594314)), units="days")),
                                days_ver_last = as.numeric(difftime(as.POSIXct(ymd_hms(last_mod_ts)), as.POSIXct(ymd_hms(d_914594314)), units="days")),
                                ver_M1 = as.numeric(difftime(as.POSIXct(ymd_hms(d_517311251)), as.POSIXct(ymd_hms(d_914594314)), units="hours")),
                                ver_M2 = as.numeric(difftime(as.POSIXct(ymd_hms(d_832139544)), as.POSIXct(ymd_hms(d_914594314)), units="hours")),
                                ver_M3 = as.numeric(difftime(as.POSIXct(ymd_hms(d_770257102)), as.POSIXct(ymd_hms(d_914594314)), units="hours")),
                                ver_M4 = as.numeric(difftime(as.POSIXct(ymd_hms(d_264644252)), as.POSIXct(ymd_hms(d_914594314)), units="hours")),
                                ver_last = as.numeric(difftime(as.POSIXct(ymd_hms(last_mod_ts)), as.POSIXct(ymd_hms(d_914594314)), units="hours")),
                                ver_M1_mins=ver_M1*60,
                                ver_M2_mins=ver_M2*60,
                                ver_M3_mins=ver_M3*60,
                                ver_M4_mins=ver_M4*60)


Table4a = all_data %>% group_by(Recruit_Type) %>% filter(d_949302066==231311385) %>% 
  dplyr::summarize('N'=n(),
                   Min = min(ver_M1, na.rm = TRUE),
                   Q1 = quantile(ver_M1, 0.25, na.rm = TRUE),
                   Median = median(ver_M1, na.rm = TRUE),
                   Mean = mean(ver_M1, na.rm = TRUE), 
                   SD= sd(ver_M1, na.rm = TRUE),
                   Q3 = quantile(ver_M1, 0.75, na.rm = TRUE),
                   'Perc.85' = quantile(ver_M1, 0.85, na.rm = TRUE),
                   'Perc.90' = quantile(ver_M1, 0.90, na.rm = TRUE),
                   'Perc.95' = quantile(ver_M1, 0.95, na.rm = TRUE),
                   Max = max(ver_M1, na.rm = TRUE)) 


Table4a2 = all_data %>% filter(d_949302066==231311385) %>% 
  dplyr::summarize('N'=n(),
                   Min = min(ver_M1, na.rm = TRUE),
                   Q1 = quantile(ver_M1, 0.25, na.rm = TRUE),
                   Median = median(ver_M1, na.rm = TRUE),
                   Mean = mean(ver_M1, na.rm = TRUE), 
                   SD= sd(ver_M1, na.rm = TRUE),
                   Q3 = quantile(ver_M1, 0.75, na.rm = TRUE),
                   'Perc.85' = quantile(ver_M1, 0.85, na.rm = TRUE),
                   'Perc.90' = quantile(ver_M1, 0.90, na.rm = TRUE),
                   'Perc.95' = quantile(ver_M1, 0.95, na.rm = TRUE),
                   Max = max(ver_M1, na.rm = TRUE)) 


Table4a1 <- Table4a #need to keep Table4a's first column name consistent to bind it later in the code
names(Table4a1)[1] <- "Recruit Type"





knitr::kable(Table4a1,format.args = list(big.mark = ","),
             caption='Table 4.1 Time (in hours) from Verification to BOH Submission \n Stratified by Active and Passive Recruits', 
             row.names=FALSE, align=c("l","c","c","c","c","c","c","c"),digits=2, booktabs = TRUE)%>% 
  kable_styling(latex_options = "scale_down") 


knitr::kable(Table4a2,format.args = list(big.mark = ","),
             caption='Table 4.2 Time (in hours) from Verification to BOH Submission for All Participants',
             row.names=FALSE, align=c("l","c","c","c","c","c","c","c"),digits=2, booktabs = TRUE)%>% 
  kable_styling(latex_options = "scale_down") 
```


```{r Table5, echo=FALSE, error=FALSE, message=FALSE, warning=FALSE}




summarize_data <- function(data, filter_column, filter_value, target_column) {
  data %>% 
    filter(!!sym(filter_column) == filter_value) %>% 
    summarize('N' = n(),
              Min = min(!!sym(target_column), na.rm = TRUE),
              Q1 = quantile(!!sym(target_column), 0.25, na.rm = TRUE),
              Median = median(!!sym(target_column), na.rm = TRUE),
              Mean = mean(!!sym(target_column), na.rm = TRUE), 
              SD = sd(!!sym(target_column), na.rm = TRUE),
              Q3 = quantile(!!sym(target_column), 0.75, na.rm = TRUE),
              'Perc.85' = quantile(!!sym(target_column), 0.85, na.rm = TRUE),
              'Perc.90' = quantile(!!sym(target_column), 0.90, na.rm = TRUE),
              'Perc.95' = quantile(!!sym(target_column), 0.95, na.rm = TRUE),
              Max = max(!!sym(target_column), na.rm = TRUE))
}


Table4b <- summarize_data(all_data, "d_536735468", 231311385, "ver_M2")
Table4c <- summarize_data(all_data, "d_976570371", 231311385, "ver_M3")
Table4d <- summarize_data(all_data, "d_663265240", 231311385, "ver_M4")
Table4e <- summarize_data(all_data, "d_100767870", 353358909, "ver_last")



### Table4a2 in previous chunk
tb5boh <- as.data.frame(Table4a2)
table4 <- rbind(tb5boh, Table4b, Table4c, Table4d, Table4e)



table4<- table4[, c(1:7, 9, 11)]
table4[,10] <- c("BOH", "MRE", "SAS", "LAW", "All")
table4<- table4[, c(10,1:9)]
colnames(table4)[1] <- "Section"


knitr::kable(table4,format.args = list(big.mark = ","),
             caption='Table 5. Time (in hours) from Verification to Initial Survey Module Submission',
             row.names=FALSE, align=c("l","c","c","c","c","c","c","c"),digits=2, booktabs = TRUE)%>% 
  kable_styling(latex_options = "scale_down") 

```



\FloatBarrier

```{r Table4_trend1, echo=FALSE, error=FALSE, message=FALSE, warning=FALSE, results='asis', include=FALSE}



combined_plot <- ggplot(all_data, aes(x = as.Date(d_914594314))) +
  stat_summary(aes(y = ver_M1_mins, color = "BOH"), fun = "mean", geom = "line", size = 0.5) +
  stat_summary(aes(y = ver_M2_mins, color = "MRE"), fun = "mean", geom = "line", size = 0.5) +
  stat_summary(aes(y = ver_M3_mins, color = "SAS"), fun = "mean", geom = "line", size = 0.5) +
  stat_summary(aes(y = ver_M4_mins, color = "LAW"), fun = "mean", geom = "line", size = 0.5) +
  scale_x_date(name = "Date", date_labels = "%y-%m-%d", date_breaks = "2 weeks", expand = c(0, 0)) +
  scale_y_continuous(name = "Time (in minutes)", limits = c(-10, 450), expand = c(0, 0)) +
  theme(
    panel.background = element_blank(),
    legend.position = "bottom",
    legend.title = element_text(face = "bold"),
    axis.line = element_line(size = 0.2),
    axis.text.x = element_text(angle = 60, hjust = 1),
    axis.title.x = element_text(size = 14, face = "bold"),
    axis.title.y = element_text(size = 14, face = "bold", color = "black"),
    plot.title = element_text(hjust = 0.5, size = 12, face = "bold")
  ) +
  theme(
    plot.caption = element_text(hjust = 0),
    legend.title = element_text(size = 8.5)
  ) +
  labs(caption = "Survey Submission Times greater than 450 minutes (7.5 hours) have been excluded to 
       properly view the average Submission Time frames.") +
  ggtitle(label = "Figure 1. Overall Weekly Average Time (in minutes) \n from Verification to Initial Survey Submission") + 
  labs(color = "Initial Survey")

# Print or display the combined plot
print(combined_plot)



```


\FloatBarrier
```{r Table4_trends2, echo=FALSE, error=FALSE, message=FALSE, warning=FALSE, results='asis', include=FALSE}

timetrend2a <- ggplot(all_data, aes(x = as.Date(d_914594314), y = ver_M1_mins, color = Recruit_Type)) +
  stat_summary(fun = "mean", geom = "line", size = 0.5) +
  scale_x_date(name = "Date", date_labels = "%y-%m-%d", date_breaks = "2 weeks", expand = c(0, 0)) +
  scale_y_continuous(name = "Time (in minutes)", limits = c(-10, 450), expand = c(0, 0)) +
  theme(
    panel.background = element_blank(),
    legend.position = "bottom",
    axis.line = element_line(size = 0.2),
    axis.text.x = element_text(angle = 60, hjust = 1),
    axis.title.x = element_text(size = 14, face = "bold"),
    axis.title.y = element_text(size = 14, face = "bold", color = "black"),
    plot.title = element_text(hjust = 0.5, size = 12, face = "bold")
  ) +
  theme(
    plot.caption = element_text(hjust = 0),
    legend.title = element_text(size = 8.5)
  ) +
  labs(caption = "Survey Submission Times greater than 450 minutes (7.5 hours) have been excluded to 
       properly view the average Submission Time frames.") +
  ggtitle(label = "Figure 2.1 Weekly Average Time (in minutes) from Verification to BOH Submission") +
  guides(color = guide_legend(title = "Recruitment Status"))

timetrend2a



timetrend2b <- ggplot(all_data, aes(x = as.Date(d_914594314), y = ver_M2_mins, color = Recruit_Type)) +
  stat_summary(fun = "mean", geom = "line", size = 0.5) +
  scale_x_date(name = "Date", date_labels = "%y-%m-%d", date_breaks = "2 weeks", expand = c(0, 0)) +
  scale_y_continuous(name = "Time (in minutes)", limits = c(-10, 450), expand = c(0, 0)) +
  theme(
    panel.background = element_blank(),
    legend.position = "bottom",
    axis.line = element_line(size = 0.2),
    axis.text.x = element_text(angle = 60, hjust = 1),
    axis.title.x = element_text(size = 14, face = "bold"),
    axis.title.y = element_text(size = 14, face = "bold", color = "black"),
    plot.title = element_text(hjust = 0.5, size = 12, face = "bold")
  ) +
  theme(
    plot.caption = element_text(hjust = 0),
    legend.title = element_text(size = 8.5)
  ) +
  labs(caption = "Survey Submission Times greater than 450 minutes (7.5 hours) have been excluded to 
       properly view the average Submission Time frames.") +
  ggtitle(label = "Figure 2.2 Weekly Average Time (in minutes) from Verification to MRE Submission") +
  guides(color = guide_legend(title = "Recruitment Status"))

timetrend2b



timetrend2c <- ggplot(all_data, aes(x = as.Date(d_914594314), y = ver_M3_mins, color = Recruit_Type)) +
  stat_summary(fun = "mean", geom = "line", size = 0.5) +
  scale_x_date(name = "Date", date_labels = "%y-%m-%d", date_breaks = "2 weeks", expand = c(0, 0)) +
  scale_y_continuous(name = "Time (in minutes)", limits = c(-10, 450), expand = c(0, 0)) +
  theme(
    panel.background = element_blank(),
    legend.position = "bottom",
    axis.line = element_line(size = 0.2),
    axis.text.x = element_text(angle = 60, hjust = 1),
    axis.title.x = element_text(size = 14, face = "bold"),
    axis.title.y = element_text(size = 14, face = "bold", color = "black"),
    plot.title = element_text(hjust = 0.5, size = 12, face = "bold")
  ) +
  theme(
    plot.caption = element_text(hjust = 0),
    legend.title = element_text(size = 8.5)
  ) +
  labs(caption = "Survey Submission Times greater than 450 minutes (7.5 hours) have been excluded to 
       properly view the average Submission Time frames.") +
  ggtitle(label = "Figure 2.3 Weekly Average Time (in minutes) from Verification to SAS Submission") +
  guides(color = guide_legend(title = "Recruitment Status"))

timetrend2c



timetrend2d <- ggplot(all_data, aes(x = as.Date(d_914594314), y = ver_M4_mins, color = Recruit_Type)) +
  stat_summary(fun = "mean", geom = "line", size = 0.5) +
  scale_x_date(name = "Date", date_labels = "%y-%m-%d", date_breaks = "2 weeks", expand = c(0, 0)) +
  scale_y_continuous(name = "Time (in minutes)", limits = c(-10, 450), expand = c(0, 0)) +
  theme(
    panel.background = element_blank(),
    legend.position = "bottom",
    axis.line = element_line(size = 0.2),
    axis.text.x = element_text(angle = 60, hjust = 1),
    axis.title.x = element_text(size = 14, face = "bold"),
    axis.title.y = element_text(size = 14, face = "bold", color = "black"),
    plot.title = element_text(hjust = 0.5, size = 12, face = "bold")
  ) +
  theme(
    plot.caption = element_text(hjust = 0),
    legend.title = element_text(size = 8.5)
  ) +
  labs(caption = "Survey Submission Times greater than 450 minutes (7.5 hours) have been excluded to 
       properly view the average Submission Time frames.") +
  ggtitle(label = "Figure 2.4 Weekly Average Time (in minutes) from Verification to LAW Submission") +
  guides(color = guide_legend(title = "Recruitment Status"))

timetrend2d

```





\newpage



```{r Submission_Minutes,echo=FALSE,error=FALSE,message=FALSE,results='asis'}



process_module <- function(data, start_time, end_time, completion_flag, completion_status, module_name) {
  
  
  data <- data %>%
    filter(!!sym(completion_flag) == completion_status)
  
  
  comp_tm <- as.numeric(difftime(as.POSIXct(ymd_hms(data[[start_time]])), 
                                 as.POSIXct(ymd_hms(data[[end_time]])), 
                                 units = "hours"))
  
  
  data <- data %>%
    mutate(comp_mins = comp_tm * 60,
           time_frame = case_when(
             comp_mins < 5 ~ "Under 5 minutes",
             comp_mins < 10 ~ "5 to 10 minutes",
             comp_mins < 15 ~ "10 to 15 minutes",
             comp_mins < 20 ~ "15 to 20 minutes",
             comp_mins < 30 ~ "20 to 30 minutes",
             comp_mins < 45 ~ "30 to 45 minutes",
             comp_mins < 60 ~ "45 to 60 minutes",
             comp_mins >= 60 ~ "60 minutes+",
             is.na(data[[start_time]]) | is.na(data[[end_time]]) ~ "Missing Time Stamp(s)"
           ))
  
  data$time_frame <- factor(data$time_frame, levels = c(
    "Under 5 minutes", "5 to 10 minutes", "10 to 15 minutes",
    "15 to 20 minutes", "20 to 30 minutes", "30 to 45 minutes",
    "45 to 60 minutes", "60 minutes+", "Missing Time Stamp(s)"
  ))
  
  summary_data <- data %>%
    group_by(time_frame) %>%
    summarize(n = n(), percentage = 100 * n / nrow(data)) %>%
    ungroup() %>%
    mutate(cumulative_percentage = cumsum(percentage)) %>%
    select(time_frame, n, percentage, cumulative_percentage)
  
  summary_row <- summary_data %>%
    summarize(n = sum(n), percentage = 100, 
              cumulative_percentage = 100,
              time_frame = "Total")
  
  summary_data <- bind_rows(summary_data, summary_row)
  
  table_summary <- summary_data %>%
    mutate(np = paste0(n, " (", round(percentage, digits = 2), "%)"),
           cumulative_percentage = paste0(round(cumulative_percentage, digits = 2), "%")) %>%
    select(time_frame, np, cumulative_percentage)
  
  knitr::kable(table_summary, 
               caption = paste0('Table ', module_name, ' Section Initial Survey Submission Time \n from Start to Submit for Verified Participants'), 
               col.names = c("Submission Time", "Total Participants", "Cumulative Percentage"), 
               row.names = FALSE, align = c("l", "c"), digits = 1, booktabs = TRUE) %>%  
    add_indent(seq(1, nrow(table_summary) - 1)) %>% 
    kable_styling(latex_options = "hold_position")
}


table6.1_sum <- process_module(all_data, "d_517311251", "d_205553981", "d_949302066", 231311385, "6.1 BOH")
table6.2_sum <- process_module(all_data, "d_832139544", "d_541836531", "d_536735468", 231311385, "6.2 MRE")
table6.3_sum <- process_module(all_data, "d_770257102", "d_386488297", "d_976570371", 231311385, "6.3 SAS")
table6.4_sum <- process_module(all_data, "d_264644252", "d_452942800", "d_663265240", 231311385, "6.4 LAW")

table6.1_sum
table6.2_sum
table6.3_sum
table6.4_sum


```

\FloatBarrier

```{r Table7,echo=FALSE,error=FALSE,message=FALSE,results='asis'}

summarize_variable <- function(data, variable) {
  data %>%
    summarize(
      N = n(),
      Min = min(!!variable, na.rm = TRUE),
      Q1 = quantile(!!variable, 0.25, na.rm = TRUE),
      Median = median(!!variable, na.rm = TRUE),
      Mean = mean(!!variable, na.rm = TRUE),
      SD = sd(!!variable, na.rm = TRUE),
      Q3 = quantile(!!variable, 0.75, na.rm = TRUE),
      #Perc.85 = quantile(!!variable, 0.85, na.rm = TRUE),
      Perc.90 = quantile(!!variable, 0.90, na.rm = TRUE),
      #Perc.95 = quantile(!!variable, 0.95, na.rm = TRUE),
      Max = max(!!variable, na.rm = TRUE)
    )
}


variables <- c("m1_comp_mins", "m2_comp_mins", "m3_comp_mins", "m4_comp_mins")

# Summarize each variable and bind rows
Table7 <- bind_rows(
  lapply(variables, function(var) summarize_variable(all_data, sym(var)))
)


# Add the section labels
Table7$Section <- c("BOH", "MRE", "SAS", "LAW")


knitr::kable(Table7[, c(10,1:9)], format.args = list(big.mark = ","),
             caption='Table 7. Time (in minutes) from Start to Submit of Initial Survey Modules',
             row.names=FALSE, align=c("l","c","c","c","c","c","c","c"),digits=2, booktabs = TRUE)%>% 
  kable_styling(latex_options = "HOLD_position") 

```








```{r Section8, echo=FALSE, warning = FALSE}



cannot_ver <- data_c %>%  filter(d_821247024==219863910 & d_512820379==486306141) %>%  
  mutate(sect_comp= case_when((d_949302066==231311385 | d_536735468==231311385 | d_976570371==231311385 | d_663265240==231311385) ~ "At Least One",
                              TRUE ~ "None"))

Numb5 <- cannot_ver %>% group_by(sect_comp) %>%    dplyr::summarize(n=n(), percentage=100*n/nrow(.))  %>% dplyr::ungroup() %>%  dplyr::select(sect_comp, n, percentage)

Numb5_table <- Numb5 %>% mutate(np = paste0(n, " (", round(percentage, digits=2), "%)")) %>% select(sect_comp, np)

Numb5_table[dim(Numb5_table)[[1]]+1 , ] <- list("Total", paste(sum(Numb5$n), " (100%)"))


knitr::kable(Numb5_table, 
             caption='Table 8. Inital Survey Submission Status among Active Recruits who Could Not be Verified', 
             col.names=c("Sections Submitted", "Active recruits"), 
             row.names=FALSE, align=c("l","c"),digits=1, booktabs = TRUE) %>%  
  add_indent(c(1:2)) %>% 
  kable_styling(latex_options = "hold_position")


```


\newpage

```{r Menstrual, echo=FALSE, warning = FALSE, message=FALSE}


mens_ccc <- "WITH combined_survey AS (
  SELECT Connect_ID
  FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.bioSurvey_v1_JP`
  WHERE d_112151599 = '353358909'

  UNION DISTINCT

  SELECT Connect_ID
  FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.clinicalBioSurvey_v1_JP`
  WHERE d_112151599 = '353358909'
)

SELECT p.Connect_ID, p.d_459098666, p.d_253883960, p.d_265193023
FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP` p
JOIN combined_survey c ON p.Connect_ID = c.Connect_ID
WHERE (p.d_253883960 = '231311385' OR p.d_265193023 = '231311385')"


mens_table_cc <- bq_project_query(project_cc, mens_ccc)
menstrual <- bq_table_download(mens_table_cc, bigint = "integer64")

mens_surv <- menstrual %>%  mutate(menst=case_when(d_459098666==231311385~"Submitted",
                                                   d_459098666==615768760~"Started",
                                                   d_459098666==972455046~"Not Started"),
                                setting= case_when(d_265193023=='231311385' ~ "Among Research Collections",
                                                   d_253883960=='231311385' ~ "Among Clinical Collections")) %>% 
      tbl_cross(
    row = menst,
    col =setting,
    digits=c(0,1),
    percent = "column",
    label=list(menst="Submission Status",
                setting = " "),
    missing="ifany",
    margin_text="Total") 


mens_surv_status <- 
  mens_surv %>%
  #bold_labels() %>%
  #italicize_levels() %>%
  modify_header(stat_0 = "Total") %>%
  modify_caption("Table 9. Menstrual Cycle Survey Submission Status for Eligible Participants") %>%
  as_kable_extra(escape = FALSE, addtl_fmt = TRUE)

add_footnote(mens_surv_status, "Note: Eligible participants are those that completed the Clinical Biospecimen Blood and Urine Survey or the Research Biospecimen Blood, Urine and Mouthwash survey. On that survey they must also have answered yes to SrvBlU_MENST60_v2r0, indicating that they have had a menstrual period in the last 60 days.", notation = "none")


```





```{r SSN, echo=FALSE, warning = FALSE}
# ssn_surv = all_data %>%  mutate(started=case_when(d_126331570==615768760 ~ "Started",
#                                                 d_126331570==231311385 ~ "Submitted",
#                                                 TRUE ~ "Not Started"),
#                                 provided4 =case_when(d_311580100==353358909 ~ "Full SSN Given",
#                                                      d_914639140==353358909 ~ "Partial SSN Given",
#                                                      TRUE ~ "No SSN given"))
ssn_surv = all_data %>%  mutate(provided4 =case_when(d_311580100==353358909 ~ "Full SSN",
                                                     d_914639140==353358909 ~ "Partial SSN",
                                                     TRUE ~ "No SSN"))
ssn_surv$provided4<- factor(ssn_surv$provided4,levels=c("Full SSN", "Partial SSN", "No SSN"))

ssn_surv = ssn_surv %>% mutate(started=case_when(d_126331570==615768760 ~ "Started",
                           d_126331570==231311385 ~ "Submitted",
                           TRUE ~ "Not Started"))



 
ssn_surv %>% tbl_cross(
    row = started,
    col =provided4,
    digits=c(0,1),
    percent = "row",
    label=list(started="Submission Status",
                provided4 = "Portion of SSN Given"),
    missing="ifany",
    margin_text="Total") %>% 


# ssn_surv %>%
#   #bold_labels() %>%
  #italicize_levels() %>%
  modify_header(stat_0 = "Total") %>%
  modify_caption("Table 10. Portion of SSN Given by Submission Status of SSN Survey") %>%
  as_kable_extra(escape = FALSE, addtl_fmt = TRUE)

```





```{r Pref_Lang_Time_All, echo=FALSE, warning = FALSE, include=TRUE}

all_data %>% tbl_cross(
    col =Site,
    row = Pref_lang,
    digits=c(0,1),
    percent = "row",
    label=list(Pref_lang="Preferred Language",
                Site = "Site"),
    missing="ifany",
    margin_text="Total") %>% 
  modify_header(stat_0 = "Total") %>%
  modify_caption("Table 11. Preferred Language by Site") %>%
  as_kable_extra(escape = FALSE, addtl_fmt = TRUE) %>%  
  kable_styling(latex_options = "scale_down")

```





```{r Survey_Flag_Setup, echo=FALSE, warning = FALSE, include=FALSE}


# Define queries
queries <- list(
  m1_lang_c = "SELECT m1.Connect_ID, m1.d_784119588, d_255077064
                FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.module1_v2_JP` m1
                left join `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP` pts
                on m1.Connect_ID=pts.Connect_ID
                WHERE m1.Connect_ID IS NOT NULL and d_949302066='231311385'",
  m2_lang_c = "SELECT m2.Connect_ID, m2.d_784119588, d_255077064 
                FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.module2_v2_JP` m2
                left join `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP` pts
                on m2.Connect_ID=pts.Connect_ID
                WHERE m2.Connect_ID IS NOT NULL and d_976570371='231311385'",
  m3_lang_c = "SELECT m3.Connect_ID, m3.d_784119588, d_255077064 
                FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.module3_v1_JP` m3
                left join `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP` pts
                on m3.Connect_ID=pts.Connect_ID
                WHERE m3.Connect_ID IS NOT NULL and d_976570371='231311385'",
  m4_lang_c = "SELECT m4.Connect_ID, m4.d_784119588, d_255077064 
                FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.module4_v1_JP` m4
                left join `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP` pts
                on m4.Connect_ID=pts.Connect_ID
                WHERE m4.Connect_ID IS NOT NULL and pts.d_663265240='231311385'",
  BUM_lang_c = "SELECT bum.Connect_ID, bum.d_784119588, d_255077064 
                FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.bioSurvey_v1_JP` bum
                left join `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP` pts
                on bum.Connect_ID=pts.Connect_ID
                WHERE bum.Connect_ID IS NOT NULL and d_265193023='231311385'",
  BU_lang_c = "SELECT bu.Connect_ID, bu.d_784119588, d_255077064
                FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.clinicalBioSurvey_v1_JP` bu 
                left join `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP` pts
                on bu.Connect_ID=pts.Connect_ID
                WHERE bu.Connect_ID IS NOT NULL and d_253883960='231311385'",
  CV_lang_c = "SELECT cv.Connect_ID, cv.d_784119588, d_255077064 
                FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.covid19Survey_v1_JP` cv
                left join `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP` pts
                on cv.Connect_ID=pts.Connect_ID
                WHERE cv.Connect_ID IS NOT NULL and d_220186468='231311385'",
  Mens_lang_c = "SELECT mns.Connect_ID, mns.d_784119588, d_255077064 
                FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.menstrualSurvey_v1_JP` mns
                left join `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP` pts
                on mns.Connect_ID=pts.Connect_ID
                WHERE mns.Connect_ID IS NOT NULL and d_459098666='231311385'",
  MW_lang_c = "SELECT mw.Connect_ID, mw.d_784119588, d_255077064 
                FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.mouthwash_v1_JP` mw
                left join `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP` pts
                on mw.Connect_ID=pts.Connect_ID
                WHERE mw.Connect_ID IS NOT NULL and d_547363263='231311385'",
  QOL_lang_c = "SELECT qol.Connect_ID, qol.d_784119588, d_255077064
                FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.promis_v1_JP` qol
                left join `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP` pts
                on qol.Connect_ID=pts.Connect_ID
                WHERE qol.Connect_ID IS NOT NULL and d_320303124='231311385'"
  #parts_lang_c = "SELECT Connect_ID, d_784119588 FROM `nih-nci-dceg-connect-prod-6d04.FlatConnect.participants_JP` WHERE Connect_ID IS NOT NULL and d_126331570='231311385'"
)

# Initialize an empty list to store results
results_list <- list()

# Loop through queries and download data
for (name in names(queries)) {
  query <- queries[[name]]
  query_result <- bq_project_query(project_cc, query)
  data <- bq_table_download(query_result, bigint = "integer64")
  results_list[[name]] <- data
}

# Access the data frames from the list
m1_lang <- results_list$m1_lang_c
m2_lang <- results_list$m2_lang_c
m3_lang <- results_list$m3_lang_c
m4_lang <- results_list$m4_lang_c
BUM_lang <- results_list$BUM_lang_c
BU_lang <- results_list$BU_lang_c
CV_lang <- results_list$CV_lang_c
Mens_lang <- results_list$Mens_lang_c
MW_lang <- results_list$MW_lang_c
QOL_lang <- results_list$QOL_lang_c
#parts_lang <- results_list$parts_lang_c



```

                          
\FloatBarrier
```{r Svy_Lang_Compare, echo=FALSE, warning = FALSE, include=TRUE}
# Define the list of survey data frames and acronyms
survey_dfs <- list(m1_lang, m2_lang, m3_lang, m4_lang, BUM_lang, BU_lang, CV_lang, Mens_lang, MW_lang, QOL_lang)
survey_acronyms <- c("BOH", "MRE", "SAS", "LAW", "BUM", "BU", "COVID", "MENS", "MW", "QOL")

# Function to create the table with given data frame and acronym
create_table <- function(current_df, current_acronym) {
  if (nrow(current_df) == 0) {
    return(data.frame(Survey = current_acronym, English = 0, Spanish = 0, Total = 0))
  }
  
  all_svry_flags <- current_df %>%
    mutate(Survey = case_when(!is.na(Connect_ID) ~ current_acronym,
                              TRUE ~ "NA"),
           Flag = case_when(d_784119588 == 773342525 ~ "Spanish",
                            TRUE ~ "English")) %>%
    tbl_cross(
      col =Flag,
      row = Survey,
      digits = c(0, 1),
      percent = "row",
      label = list(Flag = "Survey Flag",
                   Site = "Survey"),
      missing = "ifany",
      margin_text = "Total") %>%
    modify_header(stat_0 = "Total")
  
  df_all_svry_flags <- as.data.frame(all_svry_flags)
  colnames(df_all_svry_flags)[1] <- "Survey"
  df_all_svry_flags <- df_all_svry_flags[2,]
  
  # Ensure the data frame has consistent columns by adding missing ones with zeros
  expected_columns <- c("Survey", "English", "Spanish", "Total")
  missing_columns <- setdiff(expected_columns, names(df_all_svry_flags))
  
  if (length(missing_columns) > 0) {
    for (col in missing_columns) {
      df_all_svry_flags[[col]] <- 0
    }
  }
  
  # Reorder columns to match expected order
  df_all_svry_flags <- df_all_svry_flags[expected_columns]
  
  return(df_all_svry_flags)
}

# Initialize empty lists to store the results for each condition
all_flags_list_overall <- list()
all_flags_list_condition1 <- list()
all_flags_list_condition2 <- list()

# Loop through each survey data frame and acronym
for (i in seq_along(survey_dfs)) {
  # Get the current data frame and acronym
  current_df <- survey_dfs[[i]]
  current_acronym <- survey_acronyms[i]
  
  # Overall table
  df_overall <- create_table(current_df, current_acronym)
  all_flags_list_overall[[current_acronym]] <- df_overall
  
  # Table where current_df$d_255077064 == 773342525
  current_df_cond1 <- current_df %>% filter(d_255077064 == 773342525)
  df_condition1 <- create_table(current_df_cond1, current_acronym)
  all_flags_list_condition1[[current_acronym]] <- df_condition1
  
  # Table where current_df$d_255077064 == 163149180 | is.na(current_df$d_255077064)
  current_df_cond2 <- current_df %>% filter(d_255077064 == 163149180 | is.na(d_255077064))
  df_condition2 <- create_table(current_df_cond2, current_acronym)
  all_flags_list_condition2[[current_acronym]] <- df_condition2
}

# Combine all results into single data frames
final_df_overall <- do.call(rbind, all_flags_list_overall)
final_df_condition1 <- do.call(rbind, all_flags_list_condition1)
final_df_condition2 <- do.call(rbind, all_flags_list_condition2)

# View the final combined data frames


knitr::kable(final_df_overall,
               caption = paste0("Table 12. Survey Completion by Survey Language \n Among All Participants"),
               row.names = FALSE, align = c("l","c","c","c"), digits = 2, booktabs = TRUE) %>% 
  add_indent(1:10) %>%  
  kable_styling(latex_options = "HOLD_position")

knitr::kable(final_df_condition1,
               caption = paste0("Table 12.a. Survey Completion by Survey Language \n Among Participants with Preferred language of Spanish"),
               row.names = FALSE, align = c("l","c","c","c"), digits = 2, booktabs = TRUE) %>% 
  add_indent(1:10) %>%  
  kable_styling(latex_options = "HOLD_position")

knitr::kable(final_df_condition2,
               caption = paste0("Table 12.b. Survey Completion by Survey Language \n Among Participants with Preferred language of English"),
               row.names = FALSE, align = c("l","c","c","c"), digits = 2, booktabs = TRUE) %>% 
  add_indent(1:10) %>%  
  kable_styling(latex_options = "HOLD_position")


```


\FloatBarrier
```{r Svy_Lang_Diff, echo=FALSE, warning = FALSE, include=TRUE}



# Define the list of survey data frames
survey_dfs <- list(m1_lang, m2_lang, m3_lang, m4_lang, BUM_lang, BU_lang, CV_lang, Mens_lang, MW_lang, QOL_lang)

# Initialize a data frame to store the counts for each scenario
scenario_counts <- data.frame(
  Scenario = c(
    "Flag == Spanish & Pref_lang == Spanish",
    "Flag == Spanish & Pref_lang != Spanish",
    "Flag != Spanish & Pref_lang == Spanish",
    "Flag == English & Pref_lang == English",
    "Flag == English & Pref_lang != English",
    "Flag != English & Pref_lang == English"
  ),
  Count = 0
)

# Loop through each survey data frame
for (current_df in survey_dfs) {
  # Apply the necessary mutations
  current_df <- current_df %>%
    mutate(
      Flag = case_when(d_784119588 == 773342525 ~ "Spanish", TRUE ~ "English"),
      Pref_lang = case_when(d_255077064 == 773342525 ~ "Spanish", TRUE ~ "English")
    )
  
  # Calculate counts for each scenario and add to the total counts
  scenario_counts$Count[1] <- scenario_counts$Count[1] + nrow(current_df %>% filter(Flag == "Spanish" & Pref_lang == "Spanish"))
  scenario_counts$Count[2] <- scenario_counts$Count[2] + nrow(current_df %>% filter(Flag == "Spanish" & Pref_lang != "Spanish"))
  scenario_counts$Count[3] <- scenario_counts$Count[3] + nrow(current_df %>% filter(Flag != "Spanish" & Pref_lang == "Spanish"))
  scenario_counts$Count[4] <- scenario_counts$Count[4] + nrow(current_df %>% filter(Flag == "English" & Pref_lang == "English"))
  scenario_counts$Count[5] <- scenario_counts$Count[5] + nrow(current_df %>% filter(Flag == "English" & Pref_lang != "English"))
  scenario_counts$Count[6] <- scenario_counts$Count[6] + nrow(current_df %>% filter(Flag != "English" & Pref_lang == "English"))
}


 knitr::kable(scenario_counts,
               caption = "Table 13. Consistency of Language Choice in Survey Completion",
               row.names = FALSE, align = c("l","c","c","c","c","c","c","c"), digits = 2, booktabs = TRUE) %>%
    kable_styling(latex_options = "HOLD_position")

```




\FloatBarrier
```{r Pref_Lang_Time, echo=FALSE, warning = FALSE, include=TRUE}

summarize_variable <- function(data, variable) {
  data %>%
    summarize(
      N = n(),
      Min = min(!!variable, na.rm = TRUE),
      Q1 = quantile(!!variable, 0.25, na.rm = TRUE),
      Median = median(!!variable, na.rm = TRUE),
      Mean = mean(!!variable, na.rm = TRUE),
      SD = sd(!!variable, na.rm = TRUE),
      Q3 = quantile(!!variable, 0.75, na.rm = TRUE),
      Perc.90 = quantile(!!variable, 0.90, na.rm = TRUE),
      Max = max(!!variable, na.rm = TRUE)
    )
}


generate_table <- function(data, language, table_id) {
  filtered_data <- data %>% filter(Pref_lang == language)
  variables <- c("m1_comp_mins", "m2_comp_mins", "m3_comp_mins", "m4_comp_mins")
  
  Table7 <- bind_rows(
    lapply(variables, function(var) summarize_variable(filtered_data, sym(var)))
  )
  
  # Add the section labels
  Table7$Section <- c("BOH", "MRE", "SAS", "LAW")
  
  # Format the table and replace NA values with "-"
  Table7 <- Table7 %>%
    mutate(across(everything(), ~ ifelse(is.na(.), "-", .)))
  
  
  knitr::kable(Table7[, c(10, 1:9)],
               caption = paste0("Table 14.", table_id, ". Time (in minutes) from Start to Submit of Initial Survey Modules for ", language),
               row.names = FALSE, align = c("l","c","c","c","c","c","c","c"), digits = 2, booktabs = TRUE) %>%
    kable_styling(latex_options = "HOLD_position")
}


languages <- unique(all_data$Pref_lang)
table_ids <- c("a", "b")


table_list <- list()

for (i in seq_along(languages)) {
  table_list[[i]] <- generate_table(all_data, languages[i], table_ids[i])
}


table_list[[1]] 
#table_list[[2]] 


```


