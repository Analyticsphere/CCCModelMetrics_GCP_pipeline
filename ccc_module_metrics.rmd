---
title: "Weekly CCC Metrics for Modules 1-4"
output:
  pdf_document: default
  word_document: default
  html_document:
    df_print: paged
---


```{r, include=FALSE, warning=FALSE}
## Have to manually run this section, then you can knit

library(bigrquery)
library(dplyr)
library(gmodels)
library(epiDisplay)
library(lubridate)
library(tidyverse)
library(gt)
library(kableExtra)
library(knitr)
library(gtsummary)
library(tidyr)
#install_tinytex()
library(tinytex)

options(width = 80)


bq_auth()

```


```{r, include=FALSE}
## CCC WEEKLY METRICS REPORT 



### To run the code, note questions 1,5,6,7, and 8 apply to all modules and questions 2-4 apply individually to each module. Run #1 first, then #2-4 for reach module, then #6-8



##Load Data from BQ

project_cc = "nih-nci-dceg-connect-prod-6d04"
billing_cc= "nih-nci-dceg-connect-prod-6d04"
queryreccc <- "SELECT  Connect_ID, d_512820379, d_821247024, d_914594314, d_832139544, 
d_949302066 , d_205553981, d_536735468 , d_976570371, d_663265240, d_265193023, d_222161762, d_770257102, d_264644252, d_265193023, d_541836531, d_386488297, 
d_452942800, d_517311251 , d_822499427
FROM `nih-nci-dceg-connect-prod-6d04.recruitment.recruitment1_WL` where Connect_ID IS NOT NULL"

rec_table_cc <- bq_project_query(project_cc, queryreccc)
data_c <- bq_table_download(rec_table_cc, bigint = "integer64")

#data_ccc=merge(mod1_data_cc, data_ccc, by="Connect_ID")  #tidyverse has left join

data_ccc <- data_c %>% filter(d_821247024==197316935) #must be verified
dim(data_ccc) #Number of verified participants 

active_c <- data_ccc %>% filter(d_512820379==486306141)
passive_c <- data_ccc %>% filter(d_512820379==854703046)
data_ccc <- data_ccc %>% filter(d_512820379==486306141 | d_512820379==854703046) #must be active or passive
dim(data_ccc)


### Stratify by verified before all modules available in prod and, verified after all modules available in prod ###

started_m1= data_ccc %>%  filter(!is.na(d_205553981) & (d_949302066==615768760 | d_949302066==231311385))  #CID 4201878434 has no start date but completed module 1....
dim(started_m1)

data_ccc_after <- data_ccc %>% filter(!is.na(d_914594314) & d_914594314>=as.Date("2022-07-05"))  #those verified AFTER all modules were available 
dim(data_ccc_after)

data_ccc_before <- data_ccc %>% filter(!is.na(d_914594314) & d_914594314<"2022-07-05") #those verified BEFORE all were available
dim(data_ccc_before)


active_c_after <- data_ccc_after %>% filter(d_512820379==486306141)
dim(active_c_after)
passive_c_after <- data_ccc_after %>% filter(d_512820379==854703046)
dim(passive_c_after)

active_c_before <- data_ccc_before %>% filter(d_512820379==486306141)
dim(active_c_before)
passive_c_before <- data_ccc_before %>% filter(d_512820379==854703046)
dim(passive_c_before)



knitr::opts_chunk$set(comment = NA)
```


```{r, echo=FALSE}
####TIME STAMP 
currentTime <- Sys.time()
print(currentTime)
```
 

```{r, echo=FALSE}
cat("Verified Participants:", dim(data_ccc)[[1]])
cat("Date all modules available in prod: July 5, 2022")
cat("Verified participants prior to 7/5/22:", dim(data_ccc_before)[[1]])
cat("Verified participants on or after 7/5/22:", dim(data_ccc_after)[[1]])
```


```{r, include=FALSE}
# <!-- ```{css, echo=FALSE} -->
# <!-- pre { -->
# <!--   max-width: 100px; -->
# <!--   overflow-y: auto; -->
# <!-- } -->
# 
# <!-- pre[class] { -->
# <!--   max-width: 100px; -->
# <!-- } -->
# <!-- ``` -->
# 
# # ```{r kable, results = "asis"}
# # Num2_M1 %>%
# #   kable(format = "pdf") %>%
# #   kable_styling() %>%
# #   kableExtra::scroll_box(width = "100%", height = "100px")
# # ```
# 
# 
# 
# <!-- ```{css} -->
# <!--     .chart-shim { -->
# <!--       overflow: auto; -->
# <!--     } -->
# <!-- ``` -->
```



# 1.	% Submission of surveys by verified participants (including impossible scenarios)
# 
### Before all modules available

```{r, include=FALSE}
####### ALL MODULES ########

#1. Survey status of verified participants: None Completed, Some Completed (Combinations), All completed. This includes impossible selections for QC check

##BEFORE ALL AV'L--- run through once with data_tib set to before data first for first startified table
data_tib= as_tibble(data_ccc_before) #HAD TO MAKE A TIBBLE FOR GT() TABLE FUNCTION
head(data_tib)


modules <- data_tib[,c("Connect_ID","d_512820379","d_949302066","d_536735468","d_976570371","d_663265240")] 
mods <- c("d_949302066","d_536735468","d_976570371","d_663265240")
modules$modules <- 0
modules$none <-0
for(i in 1:length(mods)){
  module <- modules[,mods[i]]
  count <- ifelse((!is.na(module) & module ==231311385), 1, 0)
  modules$modules <- count+modules$modules
  count1 <- ifelse((!is.na(module) & module==972455046), 1, 0)
  modules$none <- count1+modules$none
}

table(modules$modules)

table(modules$none)

table(modules$modules,modules$d_949302066)
CrossTable(modules$d_949302066, modules$modules,digits=4, prop.t=FALSE, prop.r=TRUE, prop.c=TRUE,prop.chisq=FALSE)

length(modules[which(modules$modules==3 & modules$d_663265240==231311385 & modules$d_536735468==231311385),])
modules1 <- modules %>% mutate(process=case_when(d_949302066 == 231311385 & modules==1 ~ "module 1 only",
                                                 d_536735468 == 231311385 & modules==1 ~ "module 2 only",
                                                 d_976570371 == 231311385 & modules==1 ~ "module 3 only",
                                                 d_663265240 == 231311385 & modules==1 ~ "module 4 only",
                                                 modules ==2 & d_949302066 == 231311385 & d_536735468 == 231311385 ~ "module 1,2" ,
                                                 modules ==2 & d_949302066 == 231311385 & d_976570371 == 231311385 ~ "module 1,3" ,
                                                 modules ==2 & d_949302066 == 231311385 & d_663265240 == 231311385 ~ "module 1,4" ,
                                                 modules ==2 & d_536735468 == 231311385 & d_976570371 == 231311385 ~ "module 2,3" ,
                                                 modules ==2 & d_536735468 == 231311385 & d_663265240 == 231311385 ~ "module 2,4" ,
                                                 modules ==2 & d_976570371 == 231311385 & d_663265240 == 231311385 ~ "module 3,4" ,
                                                 modules ==3 & d_949302066 == 231311385 & d_536735468 == 231311385 & d_976570371 == 231311385 ~ "module 1,2,3" ,
                                                 modules ==3 & d_949302066 == 231311385 & d_976570371 == 231311385 & d_663265240 == 231311385~ "module 1,3,4" ,
                                                 modules ==3 & d_949302066 == 231311385 & d_536735468 == 231311385 & d_663265240 == 231311385 ~ "module 1,2,4",
                                                 modules ==3 & d_536735468 == 231311385 & d_976570371 == 231311385 & d_663265240 == 231311385 ~ "module 2,3,4" ,
                                                 modules ==0 ~ "None",
                                                 modules ==4 ~ "All"))
table(modules1$process)
tab1(modules1$process, decimal=2,sort.group = "decreasing", cum.percent = TRUE)$output.table

##MAKE INTO A PRESENTABLE TABLE:

#### ran this part before but now may not need to?
# modules1 <-as_gt(modules1) ##THIS WAS WORKING BEFORE!! WHY NOT ANYMORE?!
# head(modules1)
# ccc1 <- modules1 %>% mutate_(freq=if(!is.na(modules1$Connect_ID)){1})
# head(ccc1)
# dim(ccc1)[[1]]
# 
# ccc1$percentage= (ccc1$freq/dim(ccc1)[[1]])*100 
# head(ccc1)
# 
# dt <- ccc1[ , c(9,10, 11)] #want only frequency, process and percentage of participants 
# head(dt)



# dt_summary <- dt %>%  group_by(process) %>% summarize_at(c("freq", "percentage"), sum, na.rm = TRUE) #%>% 
# #gather("process", -freq) #not allowing decreasing frequency
# gt_print <- gt(dt_summary)
# gt_print
# 


```
